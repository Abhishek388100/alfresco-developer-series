<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <link rel="profile" href="http://gmpg.org/xfn/11" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Jeff Potts" />
  <title>Creating Custom Actions in Alfresco | ECM
Architect | Alfresco Developer Tutorials</title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="../../tutorial-common/style.css" type="text/css" />
</head>
<body class="page page-template page-template-onecolumn-page-php custom-background">
<!--
<div class="github-fork-ribbon-wrapper right">
    <div class="github-fork-ribbon">
            <a href="https://github.com/jpotts/alfresco-developer-series">Fork me on GitHub</a>
    </div>
</div>
-->
<div id="wrapper" class="hfeed">
	<div id="main">
		<div id="container" class="one-column">
			<div id="content" role="main">
				<div id="post" class="post page type-page status-draft hentry">
					<div class="entry-content">
<div id="header">
<h1 class="entry-title">Creating Custom Actions in Alfresco</h1>
<h2 class="author">Jeff Potts</h2>
<h3 class="date">January, 2012</h3>
</div>
<div id="TOC">
<ul>
<li><a href="#about-the-second-edition">About the Second Edition</a></li>
<li><a href="#license">License</a><ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#setup">Setup</a></li>
</ul></li>
<li><a href="#part-1-implementing-an-action">Part 1: Implementing an Action</a><ul>
<li><a href="#what-is-an-action">What is an Action?</a><ul>
<li><a href="#example-1-move-replaced">Example 1: Move Replaced</a></li>
<li><a href="#example-2-set-web-flag">Example 2: Set Web Flag</a></li>
</ul></li>
<li><a href="#implementing-the-move-replaced-action">Implementing the Move Replaced Action</a><ul>
<li><a href="#step-1-write-the-action-executer-class">Step 1: Write the action executer class</a></li>
<li><a href="#step-2-configure-the-action-in-spring">Step 2: Configure the action in Spring</a></li>
</ul></li>
<li><a href="#implementing-the-set-web-flag-action">Implementing the Set Web Flag action</a><ul>
<li><a href="#step-1-write-the-setwebflag-action-executer-class">Step 1: Write the SetWebFlag action executer class</a></li>
<li><a href="#step-2-configure-the-action-in-spring-1">Step 2: Configure the action in Spring</a></li>
</ul></li>
<li><a href="#java-versus-server-side-javascript">Java versus Server-side JavaScript</a></li>
</ul></li>
<li><a href="#part-2-configuring-the-actions-front-end-in-share">Part 2: Configuring the Action's Front-End in Share</a><ul>
<li><a href="#configuring-the-replaceable-aspect-in-share">Configuring the Replaceable Aspect in Share</a></li>
<li><a href="#configuring-the-move-replaced-rule-action-in-share">Configuring the Move Replaced Rule Action in Share</a><ul>
<li><a href="#step-1-specify-the-custom-client-side-component-and-set-the-action-order">Step 1: Specify the custom client-side component and set the action order</a></li>
<li><a href="#step-2-add-a-reference-to-the-custom-client-side-javascript-file-to-the-head">Step 2: Add a reference to the custom client-side JavaScript file to the head</a></li>
<li><a href="#step-3-implement-the-custom-client-side-javascript-component">Step 3: Implement the custom client-side JavaScript component</a></li>
</ul></li>
<li><a href="#configuring-the-set-web-flag-ui-action-in-share">Configuring the Set Web Flag UI Action in Share</a><ul>
<li><a href="#step-1-create-two-new-repository-tier-actions">Step 1: Create two new repository tier actions</a></li>
<li><a href="#step-2-update-share-config-custom.xml-with-the-action-configuration">Step 2: Update share-config-custom.xml with the action configuration</a></li>
<li><a href="#step-3-create-icons-and-localize-the-strings">Step 3: Create icons and localize the strings</a></li>
</ul></li>
<li><a href="#finishing-touches-evaluators-indicators">Finishing Touches: Evaluators &amp; Indicators</a><ul>
<li><a href="#step-1-declare-a-new-evaluator-in-spring-config">Step 1: Declare a new evaluator in Spring config</a></li>
<li><a href="#step-2-update-the-action-config-in-share-config-custom.xml">Step 2: Update the action config in share-config-custom.xml</a></li>
<li><a href="#step-3-update-the-share-config-custom.xml-file-to-show-a-document-library-indicator">Step 3: Update the share-config-custom.xml file to show a document library indicator</a></li>
<li><a href="#deploy-test">Deploy &amp; Test</a></li>
</ul></li>
</ul></li>
<li><a href="#conclusion">Conclusion</a><ul>
<li><a href="#where-to-find-more-information">Where to find more information</a></li>
</ul></li>
<li><a href="#appendix">Appendix</a><ul>
<li><a href="#configuring-the-replaceable-aspect-in-explorer">Configuring the Replaceable Aspect in Explorer</a></li>
<li><a href="#configuring-the-move-replaced-rule-action-in-explorer">Configuring the Move Replaced Rule Action in Explorer</a><ul>
<li><a href="#step-1-create-an-action-handler-class">Step 1: Create an action handler class</a></li>
<li><a href="#step-2-create-a-corresponding-jsp-page">Step 2: Create a corresponding JSP page</a></li>
<li><a href="#step-3-localize-the-move-replaced-action">Step 3: Localize the Move Replaced Action</a></li>
</ul></li>
<li><a href="#configuring-the-set-web-flag-ui-action-in-explorer">Configuring the Set Web Flag UI Action in Explorer</a><ul>
<li><a href="#step-1-create-a-jsf-managed-bean">Step 1: Create a JSF-managed Bean</a></li>
<li><a href="#step-2-update-web-client-config-custom.xml-with-the-new-ui-action">Step 2: Update web-client-config-custom.xml with the new UI action</a></li>
<li><a href="#step-3-localize-the-set-web-flag-action">Step 3: Localize the Set Web Flag action</a></li>
</ul></li>
<li><a href="#configuring-the-evaluator-to-showhide-the-set-web-flag-ui-action-in-explorer">Configuring the Evaluator to Show/Hide the Set Web Flag UI Action in Explorer</a></li>
</ul></li>
</ul>
</div>
<h1 id="about-the-second-edition"><a href="#about-the-second-edition">About the Second Edition</a></h1>
<p>This tutorial was originally written in January of 2007. I think it was actually the first Alfresco tutorial I wrote even though I think of “Custom Content Types” as the logical place to start from the perspective of someone ramping up on the platform.</p>
<p>The original version was very short—it focused only on how to make a custom action configurable within a rule in Alfresco Explorer.</p>
<p>The second edition greatly expands on the first by building on the SomeCo example started in the “Custom Content Types” tutorial and adding a second action example that sets a custom property defined in the example SomeCo model.</p>
<p>Similar to the second edition of “content types”, my main intent of writing this revision was to illustrate how to use the action configuration new to Alfresco 4 to wire the actions into the Alfresco Share user interface.</p>
<p>The old Alfresco Explorer instructions still exist. I've moved those to the Appendix. They work fine in Alfresco 4, so if you are stuck on Explorer, but have upgraded to Alfresco 4, you'll still find it useful.</p>
<p>The new action-related extension points in Alfresco 4 make it much, much easier to add shortcuts and other usability improvements to Share with drastically less code than you'd need to do the same thing in older versions. After you read this tutorial, you'll be able to add all sorts of cool things to your Alfresco installation. If you do, I hope you consider packaging them up as an AMP, putting the source somewhere public, and listing them on <a href="http://addons.alfresco.com/">http://addons.alfresco.com</a>.</p>
<p>As always, please let me know if you found this helpful. Any and all feedback is welcome on my blog at <a href="http://ecmarchitect.com/">http://ecmarchitect.com</a>.</p>
<p>Have fun!</p>
<p>Jeff</p>
<h1 id="license"><a href="#license">License</a></h1>
<div class="figure">
<img src="./images/cc-by-sa-88x31.png" />
</div>
<p>This work is licensed under the Creative Commons Attribution-ShareAlike 3.0 Unported License. To view a copy of this license, visit http://creativecommons.org/licenses/by-sa/3.0/ or send a letter to Creative Commons, 444 Castro Street, Suite 900, Mountain View, California, 94041, USA.</p>
<h2 id="introduction"><a href="#introduction">Introduction</a></h2>
<p>Alfresco is a flexible platform for developing content management applications. Clients have several options to consider when selecting a user interface approach. Alfresco comes with two web clients that can be used as-is or customized. Alternatively, developers can create custom applications using the Content Management Interoperability Services (CMIS) API, web scripts, the web services API or the foundation API.</p>
<p>Many times, the out-of-the-box web client is sufficient, even if it has to be customized slightly to fit your requirements. This is particularly true when your requirements closely resemble the all-purpose document management use case.</p>
<p>Deciding whether to go with the out-of-the-box web client, a customized web client, or building your own user interface from scratch requires careful thought and analysis that is beyond the scope of this document.</p>
<p>This article is the second in a series that covers Alfresco from a configuration and customization perspective. The first article discussed how to create custom content types and then expose those to the Alfresco user interface. The focus in this article is on developing custom actions and configuring the user interface to show those custom actions.</p>
<p>It is important to note that if you are looking for quick-and-dirty ways to operate against documents in the repository, you may not need a custom action. For example, you could create some server-side JavaScript that gets called from the “Execute Script” action. Or, you could run server-side JavaScript using the JavaScript Console add-on available from Share Extras (see “Where to find more information” for a link). There are CMIS APIs that allow you to perform bulk operations from the command line.</p>
<p>Actions are useful when:</p>
<ul>
<li>You want to define one or more operations that can be executed repeatedly</li>
<li>You want to make it easy for end-users to invoke common operations, either by clicking a menu item or by configuring a rule on a folder that will execute the operations automatically</li>
<li>You want to perform one or more operations on a schedule (which isn't covered in this document)</li>
</ul>
<p>Part 1 of this document explains how to implement the “back-end” piece of the action. The document includes two different examples. One action, called “Move Replaced” will be used as a “Rule Action”. The other action is called “Set Web Flag” and it will be called from menu items in the user interface.</p>
<p>Part 2 explains how to configure the user interface to work with the custom actions. The first edition of this tutorial focused on the Alfresco Explorer web client. This edition focuses on the Alfresco Share web client. The Alfresco Explorer sections have been moved to the Appendix if you need them.</p>
<h2 id="setup"><a href="#setup">Setup</a></h2>
<p>Before getting too far down the road, here are a couple of notes about my setup:</p>
<ul>
<li>Mac OS X Lion 10.7.2</li>
<li>MySQL 5.1.60 (Macports)</li>
<li>Tomcat 6.0.32</li>
<li>Java 1.6.0_29</li>
<li>Alfresco 4.0.c Community, WAR-only distribution</li>
</ul>
<p>Other operating systems, databases, application servers, and Alfresco versions will work with the examples in Part 1, but in Part 2 I use some Share extension points that are new in Alfresco 4, so older versions may not work with the Share configuration examples.</p>
<p>The code that accompanies this article is split into two Eclipse projects—one for repository tier configuration and customization and the other for Share tier configuration and customization. Each has its own build script which copies the artifacts into the appropriate places within the exploded Alfresco and Share WARs. In real life, you'll want to package your customizations as AMPs for both the repository and Share tiers.</p>
<p>The code is inclusive of the code from the “Custom Content Types, 2<sup>nd</sup> Edition” tutorial with the exception of the Web Services and CMIS examples. This example uses the SomeCo content model established in that tutorial. If you don't understand how to extend Alfresco's content model with your own or how to configure custom models in the Share and Explorer user interfaces, read that tutorial first.</p>
<h1 id="part-1-implementing-an-action"><a href="#part-1-implementing-an-action">Part 1: Implementing an Action</a></h1>
<p>Actions are very commonly used when implementing Alfresco. This part of the tutorial explains what actions are, sets up a couple of examples, then shows how actions are implemented in Java.</p>
<h2 id="what-is-an-action"><a href="#what-is-an-action">What is an Action?</a></h2>
<p>The term, “action” is overloaded quite heavily across the Alfresco platform (and application development, in general). For the purposes of this document, an action is a discrete, reusable unit of work that can be performed against an object in the repository, and can optionally be configured at run-time by the user. Some of the out-of-the-box actions include things like: Check-out, Check-in, Add Aspect, Remove Aspect, Move, Send Email, and Specialize Type.</p>
<p>Sometimes, the term “rule action” is used to describe this type of action. That's because actions are frequently used when configuring a rule on a folder. For example, suppose that there is a requirement to always create a PNG version of GIFs checked in to a specific folder. This is easily done by creating a rule that watches for new or updated GIFs and then runs the “Transform and Copy Image” action when it finds an object that meets the criteria.</p>
<p>The screenshots below show the out-of-the-box actions available when configuring a rule in Alfresco. Drawing 1 is Alfresco Explorer and Drawing 2 is Alfresco Share.</p>
<div class="figure">
<img src="./images/rule-actions-explorer.png" alt="Actions in Explorer rule config" /><p class="caption">Actions in Explorer rule config</p>
</div>
<div class="figure">
<img src="./images/rule-actions-share.png" alt="Actions in Share rule config" /><p class="caption">Actions in Share rule config</p>
</div>
<p>But actions aren't limited to running as part of a rule. Actions can be called from menu items in the user interface (both Explorer and Share). These are often called “UI actions” to distinguish the actual menu item, the UI action, from the thing that actually does the work, the “rule action” or simply, the “action”.</p>
<p>These screenshots show the “browse” UI actions and the “details” UI actions in Alfresco Explorer:</p>
<div class="figure">
<img src="./images/ui-actions-browse-explorer.png" alt="Browse UI actions in Explorer" /><p class="caption">Browse UI actions in Explorer</p>
</div>
<div class="figure">
<img src="./images/ui-actions-details-explorer.png" alt="Details UI actions in Explorer" /><p class="caption">Details UI actions in Explorer</p>
</div>
<p>Similarly, Alfresco Share has UI actions available in the document library's document list as well as the document details page:</p>
<div class="figure">
<img src="./images/ui-actions-browse-share.png" alt="Browse UI actions in Share" /><p class="caption">Browse UI actions in Share</p>
</div>
<div class="figure">
<img src="./images/ui-actions-details-share.png" alt="Details UI actions in Share" /><p class="caption">Details UI actions in Share</p>
</div>
<p>So actions can be invoked from a rule and can be triggered from a menu item. Actions can also be called from code which means they can be invoked from server-side JavaScript, workflows, web scripts, or any other piece of code that can get to the Action Service.</p>
<p>Because the same action can be invoked from all of these places, actions are a powerful way to write content operations once and then leverage them in many places.</p>
<h3 id="example-1-move-replaced"><a href="#example-1-move-replaced">Example 1: Move Replaced</a></h3>
<p>Using actions and workflow together can be an effective way to customize the web client for the needs of the business. Consider SomeCo, the fictitious company introduced in the content types tutorial. Suppose SomeCo wants to use Alfresco to manage the policies and procedures for their entire organization. They need to be able to track when a new policy or procedure is published that supersedes an older policy document.</p>
<p>SomeCo uses three folders to keep track of the state of their policies: Draft, Approved, and Archived. SomeCo uses Alfresco's Simple Workflows to move policies from folder to folder. When someone moves a policy into the Approved folder, if that policy replaces an older policy, the older policy needs to be automatically moved to the Archived folder. Alfresco has a “Move” action, but doesn't have a “Move Replaced” action. A new “Move Replaced” action can easily be created to accomplish this.</p>
<h3 id="example-2-set-web-flag"><a href="#example-2-set-web-flag">Example 2: Set Web Flag</a></h3>
<p>Recall from the first tutorial that SomeCo publishes a subset of the documents in their repository to a company portal. SomeCo uses a flag on the object to keep track of which documents should be shown on the portal. In the first tutorial, that flag was set either by editing the field in the user interface or by running code. Now it is time to make it a bit more user-friendly by providing menu items in the user interface that can enable and disable the flag.</p>
<p>The rest of this document explains how to implement both of these actions including the configuration necessary to make them available from the user interface.</p>
<h2 id="implementing-the-move-replaced-action"><a href="#implementing-the-move-replaced-action">Implementing the Move Replaced Action</a></h2>
<p>Actions run against specific nodes. In this example, the action needs to find the documents that the “actioned upon node” replaces so they can be moved. In order to do this, the action needs to know where to move the old documents to and it needs to know how to find the old documents. The first part, where to move the old documents, will be a parameter that gets passed to the action. The second part will leverage a “replaces” relationship.</p>
<p>A &quot;replaces&quot; relationship is a pretty common requirement. In fact, Alfresco already has a &quot;replaceable&quot; aspect in the out-of-the-box content model. The “replaceable” aspect defines an association called “cm:replaces”. So, the out-of-the-box content model already accommodates documents that replace other documents. All that is needed is some configuration to expose this relationship to the user interface.</p>
<p>The business logic will reside in an action executer class. This will allow SomeCo end-users to call the action from a rule configured on any folder, without further involvement from the development team.</p>
<p>Implementing the action's business logic involves two steps:</p>
<ol style="list-style-type: decimal">
<li>Writing the action executer class</li>
<li>Configuring the action in Spring</li>
</ol>
<p>Once that's done, the action can be called from code using the Action Service, or it can be wired in to the user interface (including rule configuration), which is covered in Part 2.</p>
<h3 id="step-1-write-the-action-executer-class"><a href="#step-1-write-the-action-executer-class">Step 1: Write the action executer class</a></h3>
<p>At its most basic, an action consists of an Action Executer class and its associated Spring bean configuration. Implementing an action involves extending ActionExecuterAbstractBase and then implementing the executeImpl method. Before starting, though, think about similar code that might already exist within Alfresco that might be a good starting point for the new action. Alfresco is open source--it would be a shame to ignore that valuable resource. Plus, following the same patterns to implement this customization will make it easier for someone to support and makes it easier to share our code with others or even to contribute the code back to the Alfresco community project.</p>
<p>The new action is doing a move, so the existing Move action is a good place to start. In fact, the only difference between the Move action and the custom Move Replaced action is that the node being moved isn't the current node--it's the node on the target end of a &quot;replaces&quot; association.</p>
<p>Alfresco's executer class for the Move action is called org.alfresco.repo.action.executer.MoveActionExecuter. If you have the Alfresco source you can find it in the repository project. I'll copy it into my own repository project and call it MoveReplacedActionExecuter. The executeImpl method is where the move logic is handled. It looks like this:</p>
<pre><code>public void executeImpl(Action ruleAction, NodeRef actionedUponNodeRef)
{
    NodeRef destinationParent = (NodeRef)ruleAction.getParameterValue(PARAM_DESTINATION_FOLDER);
    try
    {
        fileFolderService.move(actionedUponNodeRef, destinationParent, null);
    }
    catch (FileNotFoundException e)
    {
        // Do nothing
    }
} </code></pre>
<p>The code simply grabs the parameter value for the destination folder and then calls the FileFolderService to do the move. This is a good start for Move Replaced. All I need to do is modify the executeImpl method to find the nodes related to the current node by a &quot;replaces&quot; association, and then for each result, set up and perform a move.</p>
<pre><code>public void executeImpl(Action ruleAction, NodeRef actionedUponNodeRef) {
    // get the replaces associations for this node
    List&lt;AssociationRef&gt; assocRefs = nodeService.getTargetAssocs(actionedUponNodeRef, ((QNamePattern) QName.createQName(NamespaceService.CONTENT_MODEL_1_0_URI, &quot;replaces&quot;)) );

    // if there are none, return
    if (assocRefs.isEmpty()) {
         // no work to do, return
         return;
    } else {
        NodeRef destinationParent = (NodeRef)ruleAction.getParameterValue(PARAM_DESTINATION_FOLDER);
        for (AssociationRef assocNode : assocRefs) {
            // create a noderef for the replaces association
            NodeRef targetNodeRef = assocNode.getTargetRef();
            // if the node exists
            if (this.nodeService.exists(targetNodeRef) == true) {
                try {
                    fileFolderService.move(targetNodeRef, destinationParent, null);
                } catch (FileNotFoundException e) {
                    // Do nothing
                }
            }
        } // next assocNode
    } // end if isEmpty
} </code></pre>
<p>The only other change needed is to change the value of the constant NAME from &quot;move&quot; to &quot;move-replaced&quot;. (Throughout this document I'll only include relevant pieces of these classes—check the source that accompanies this article for code that actually compiles).</p>
<h3 id="step-2-configure-the-action-in-spring"><a href="#step-2-configure-the-action-in-spring">Step 2: Configure the action in Spring</a></h3>
<p>In the content types tutorial, you learned that Spring bean configurations go in files that end with “context.xml”. Those files reside in the “extension” directory to keep them separate from the rest of the Alfresco web application. For this example, I created a file called “someco-action-context.xml” and placed it in /config/alfresco/extension. It contains the following:</p>
<pre><code>&lt;?xml version=&#39;1.0&#39; encoding=&#39;UTF-8&#39;?&gt;
&lt;!DOCTYPE beans PUBLIC &#39;-//SPRING//DTD BEAN//EN&#39; &#39;http://www.springframework.org/dtd/spring-beans.dtd&#39;&gt;

&lt;beans&gt;
    &lt;bean id=&quot;move-replaced&quot; class=&quot;com.someco.action.executer.MoveReplacedActionExecuter&quot; parent=&quot;action-executer&quot;&gt;
        &lt;property name=&quot;fileFolderService&quot;&gt;
            &lt;ref bean=&quot;FileFolderService&quot; /&gt;
        &lt;/property&gt;
        &lt;property name=&quot;nodeService&quot;&gt;
            &lt;ref bean=&quot;NodeService&quot; /&gt;
        &lt;/property&gt;
    &lt;/bean&gt;
&lt;/beans&gt;</code></pre>
<p>That's all there is to it. You could compile the MoveReplacedActionExecuter class, JAR it up, and deploy it to Alfresco's WEB-INF/lib. The Spring context file goes in WEB-INF/classes/alfresco/extension. In fact, the Ant build file that accompanies this code does just that. Once in place, the action can be invoked from code. That's obviously not going to be useful for end users, though. Before wiring the action into the user interface, let's look at another Action Executer example.</p>
<h2 id="implementing-the-set-web-flag-action"><a href="#implementing-the-set-web-flag-action">Implementing the Set Web Flag action</a></h2>
<p>This action will be used to set the flag on content which should be shown in the SomeCo portal. Recall from the content types tutorial that the property is a boolean named “sc:isActive” which is defined as part of an aspect named “sc:webable”. Also in that aspect is a date property named “sc:published” that keeps track of when the content was last published to the portal.</p>
<p>The Set Web Flag action, then, needs to set the “sc:isActive” flag. The value to set it to (true or false) can be passed in as a parameter to the action. When the flag is set to true, the action should set the “sc:published” property with the current date.</p>
<p>This action could be called from a rule, but SomeCo intends to configure a UI action in the user interface to allow end-users the ability to enable or disable a piece of content for display on the portal with a single click.</p>
<p>Just like in the Move Replaced example, the steps are:</p>
<ol style="list-style-type: decimal">
<li>Write the action executer class</li>
<li>Configure the action in Spring</li>
</ol>
<p>Then, the action will be ready to use.</p>
<h3 id="step-1-write-the-setwebflag-action-executer-class"><a href="#step-1-write-the-setwebflag-action-executer-class">Step 1: Write the SetWebFlag action executer class</a></h3>
<p>Like the MoveReplacedAction, this action extends ActionExecuterAbstractBase. The action takes a parameter that specifies the value for the “sc:isActive” flag. Actions declare parameters by overriding the addParameterDefinitions method:</p>
<pre><code>@Override
protected void addParameterDefinitions(List&lt;ParameterDefinition&gt; paramList) {
    paramList.add(
        new ParameterDefinitionImpl(
                PARAM_ACTIVE,
                DataTypeDefinition.BOOLEAN,
                false,
                getParamDisplayLabel(PARAM_ACTIVE)));
}</code></pre>
<p>The constructor for the ParameterDefinitionImpl takes the name of the parameter, the parameter's data type, whether or not the parameter is mandatory, and a label. If the custom action had additional parameters this method would have one paramList.add call for each parameter.</p>
<p>The next step is to create the action's logic in the executeImpl method:</p>
<pre><code>@Override
protected void executeImpl(Action action, NodeRef actionedUponNodeRef) {    
    Boolean activeFlag = (Boolean)action.getParameterValue(PARAM_ACTIVE);

    if (activeFlag == null) activeFlag = true; // default

    // set the sc:isActive property to true
    Map&lt;QName, Serializable&gt; properties = nodeService.getProperties(actionedUponNodeRef);
    properties.put(
        QName.createQName(SomeCoModel.NAMESPACE_SOMECO_CONTENT_MODEL, SomeCoModel.PROP_IS_ACTIVE), activeFlag);

    if (activeFlag) {
        // set the sc:published property to now
        properties.put(
            QName.createQName(SomeCoModel.NAMESPACE_SOMECO_CONTENT_MODEL, SomeCoModel.PROP_PUBLISHED), new Date());
    }
    
    // if the aspect has already been added, set the properties
    if (nodeService.hasAspect(actionedUponNodeRef,
                QName.createQName(
                    SomeCoModel.NAMESPACE_SOMECO_CONTENT_MODEL,
                    SomeCoModel.ASPECT_SC_WEBABLE))) {
        nodeService.setProperties(actionedUponNodeRef, properties);
    } else {
        // otherwise, add the aspect and set the properties
        nodeService.addAspect(actionedUponNodeRef,
                Qname.createQName(
                    SomeCoModel.NAMESPACE_SOMECO_CONTENT_MODEL,
                    SomeCoModel.ASPECT_SC_WEBABLE), properties);
    }                  
}</code></pre>
<p>The logic should be pretty easy to follow. The code grabs the value of the active parameter. Then, it sets up a map to hold properties. If the active flag is being set to true, the date property is added to the map. The last part of the method just checks to see whether the aspect needs to be added or not. If so, the aspect can be added and the properties set in a single call.</p>
<h3 id="step-2-configure-the-action-in-spring-1"><a href="#step-2-configure-the-action-in-spring-1">Step 2: Configure the action in Spring</a></h3>
<p>The Spring configuration for this action goes in the same context file as the pervious action:</p>
<pre><code>&lt;bean id=&quot;set-web-flag&quot; class=&quot;com.someco.action.executer.SetWebFlag&quot; parent=&quot;action-executer&quot;&gt;
    &lt;property name=&quot;nodeService&quot;&gt;
        &lt;ref bean=&quot;NodeService&quot; /&gt;
    &lt;/property&gt;
&lt;/bean&gt;</code></pre>
<p>This action is now ready to be wired in to the user interface. That's covered in Part 2.</p>
<h2 id="java-versus-server-side-javascript"><a href="#java-versus-server-side-javascript">Java versus Server-side JavaScript</a></h2>
<p>A quick side-note before moving on to the front-end: The action executer examples shown in Part 1 were both implemented in Java. However, action executers can also be implemented using server-side JavaScript. The steps are the same: write the logic, then configure it through Spring. This is an attractive option for teams lacking in Java skills. The tradeoff is that the JavaScript API does not have 100% of the feature set of the Alfresco Java API. You may also see a performance difference with the JavaScript API, which essentially wraps the lower-level Java API.</p>
<h1 id="part-2-configuring-the-actions-front-end-in-share"><a href="#part-2-configuring-the-actions-front-end-in-share">Part 2: Configuring the Action's Front-End in Share</a></h1>
<p>In Part 1 of this document you learned how to create an Action Executer class. The result was an action that could be called from code. But both actions need to be invoked by end-users. In the case of the Move Replaced action, an end-user will configure a rule that will invoke the action. When the end-user configures the action, they need to specify the directory to send the replaced documents to. That means the user interface needs to know how to let the end user pick a target folder.</p>
<p>The Set Web Flag action gives end-users the ability to set the active flag and the publish date with a single click of a menu item. So the user interface needs to know where to show that menu item and how to invoke the SetWebFlag action in the repository.</p>
<p>The specific steps to configure the user interface for these two actions depend on the web client being used. Alfresco Explorer used to be the only choice. Alfresco Share is usually the preferred web client these days. Alfresco 4 added some extensibility features that make it much easier to configure actions in Share than it used to be. So I'll use Share and if you need to see how to do the exact same thing in Explorer, check the Appendix.</p>
<h2 id="configuring-the-replaceable-aspect-in-share"><a href="#configuring-the-replaceable-aspect-in-share">Configuring the Replaceable Aspect in Share</a></h2>
<p>Alfresco's out-of-the-box content model already defines an association called “cm:replaces” as part of the “cm:replaceable” aspect. But neither the aspect nor the association are configured to be displayed in the Share user interface. That's easy to fix.</p>
<p>Recall from the content types tutorial that the Share user interface configuration resides in a file called “share-config-custom.xml”. The “cm:replaceable” aspect can be added to the list of aspects a user can see, like this:</p>
<pre><code>        &lt;visible&gt;
            &lt;aspect name=&quot;sc:webable&quot; /&gt;
            &lt;aspect name=&quot;sc:productRelated&quot; /&gt;
            &lt;aspect name=&quot;cm:replaceable&quot; /&gt;
        &lt;/visible&gt;</code></pre>
<p>Next, the “cm:replaces” association needs to show up when editing properties. In this example, SomeCo will use instances of “cm:content” for policies, but this would work the same way if a specific content type, like “sc:hrPolicy”, were used instead. So I've copied the form configuration for “cm:content” from the out-of-the-box form configuration into “share-config-custom.xml”. Just like in the content types tutorial, the association is configured by adding children to the “field visibility” and “appearance” elements, like this:</p>
<pre><code>           &lt;!-- cm:geographic aspect --&gt;
           &lt;show id=&quot;cm:latitude&quot; /&gt;
           &lt;show id=&quot;cm:longitude&quot; /&gt;
           
           &lt;!-- cm:replaceable --&gt;
           &lt;show id=&quot;cm:replaces&quot; /&gt;

        &lt;/field-visibility&gt;</code></pre>
<p>and this:</p>
<pre><code>           &lt;field id=&quot;cm:sentdate&quot; read-only=&quot;true&quot; /&gt;
           &lt;field id=&quot;cm:subjectline&quot; read-only=&quot;true&quot; /&gt;
           &lt;field id=&quot;cm:replaces&quot; label-id=&quot;assoc.cm_replaces&quot;/&gt;
        &lt;/appearance&gt;</code></pre>
<p>The last step in exposing the “cm:replaceable” aspect and “cm:replaces” association is localizing the labels. The web-extension/messages/scModel.properties file already exists, so add the following:</p>
<pre><code>#cm:replaceable
aspect.cm_replaceable=Replaceable
assoc.cm_replaces=Replaces</code></pre>
<p>The next step is to configure the Move Replaced Rule Action in Share.</p>
<h2 id="configuring-the-move-replaced-rule-action-in-share"><a href="#configuring-the-move-replaced-rule-action-in-share">Configuring the Move Replaced Rule Action in Share</a></h2>
<p>Share is pretty smart. If you deploy the Move Replaced action as-is it will automatically get added to the list of actions users can select when configuring a rule. So for simple actions, you won't have to do anything further. But in this example, the action takes an argument. By default, Share will try to render a plain text field for the argument which might work in some cases. But this action takes a node reference as an argument and making an end-user provide a node reference for the target folder would be a very bad thing. Instead, Share needs to render a folder picker dialog for the target folder argument. Luckily, Alfresco has already developed such a dialog—Share just has to be told to use it.</p>
<p>In Alfresco 4, a lot of work has been done to make customizing and extending the user interface easier. Unfortunately, at the moment, getting a folder picker to show up for this action takes a bit more work than it ought to. My guess is that this will get resolved in the future. Until then, here is what is involved:</p>
<ol style="list-style-type: decimal">
<li>Override the rule config action web script to point to a custom client-side component and to set the order the action appears in the action list.</li>
<li>Override the rule details and rule edit web script to include a “script” reference in the “head” section of the page that points to the client-side JavaScript where the custom client-side component lives.</li>
<li>Write the custom client-side component.</li>
</ol>
<p>It looks like a pain, but once you figure it out it isn't too bad. And it is a lot easier than it used to be if that makes you feel any better. Let's go through the steps.</p>
<h3 id="step-1-specify-the-custom-client-side-component-and-set-the-action-order"><a href="#step-1-specify-the-custom-client-side-component-and-set-the-action-order">Step 1: Specify the custom client-side component and set the action order</a></h3>
<p>In Alfresco 4, a lot of the action configuration has been pulled into share-form-config-custom.xml. But rule config still lives in the rule config web script. This isn't a big deal—it is easy to override one or more files that make up a web script. In this case, copy the rule-config-action.get.config.xml file from $TOMCAT_HOME/webapps/share/WEB-INF/classes/alfresco/site-webscripts/org/alfresco/components/rules/config into your own project. For example, in the code that accompanies this article, I copied the file into config/alfresco/web-extension/site-webscripts/org/alfresco/components/rules/config.</p>
<p>The first change is to specify a custom client-side JavaScript component:</p>
<pre><code>&lt;rule-config type=&quot;action&quot;&gt;
   &lt;component&gt;SomeCo.RuleConfigActionCustom&lt;/component&gt;
   &lt;config-definitions webscript=&quot;/api/actiondefinitions&quot;&gt;</code></pre>
<p>This will be a new client-side JavaScript component that will get created shortly.</p>
<p>Next, the action gets arranged in the list of actions. In this case, it makes sense to see it in the list right after “Move”:</p>
<pre><code>&lt;menu&gt;
    &lt;group&gt;
        &lt;item id=&quot;select&quot;/&gt;
    &lt;/group&gt;
    &lt;group&gt;
        &lt;action name=&quot;script&quot;/&gt;
    &lt;/group&gt;
    &lt;group&gt;
        &lt;action name=&quot;copy&quot;/&gt;
        &lt;action name=&quot;move&quot;/&gt;
        &lt;action name=&quot;move-replaced&quot;/&gt;
    &lt;/group&gt;</code></pre>
<p>Finally, the action gets bound with a client-side JavaScript function:</p>
<pre><code>  &lt;action name=&quot;copy&quot;&gt;Copy&lt;/action&gt;
  &lt;action name=&quot;move&quot;&gt;Move&lt;/action&gt;
  &lt;action name=&quot;move-replaced&quot;&gt;MoveReplaced&lt;/action&gt;      
  &lt;action name=&quot;simple-workflow&quot;&gt;SimpleWorkflow&lt;/action&gt;</code></pre>
<h3 id="step-2-add-a-reference-to-the-custom-client-side-javascript-file-to-the-head"><a href="#step-2-add-a-reference-to-the-custom-client-side-javascript-file-to-the-head">Step 2: Add a reference to the custom client-side JavaScript file to the head</a></h3>
<p>The client-side JavaScript file where the custom client-side component resides needs to be pulled in to the “&lt;head&gt;” section of the page so the browser knows about it. Web scripts that end with “head.ftl” are used for this purpose. For rules, there are two web scripts that will need to refer to the custom client-side JavaScript: “rule details” and “rule edit”. So the rule-details.get.head.ftl and rule-edit.get.head.ftl files are copied from $TOMCAT_HOME/webapps/share/WEB-INF/classes/alfresco/site-webscripts/org/alfresco/components/rules. The modifications to both are identical and are as follows:</p>
<pre><code>&lt;@link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;${page.url.context}/res/components/rules/rule-details.css&quot; /&gt;
&lt;@script type=&quot;text/javascript&quot; src=&quot;${page.url.context}/res/components/rules/rule-details.js&quot;&gt;&lt;/@script&gt;
&lt;!--Custom javascript file include for detail mode --&gt;
&lt;@script type=&quot;text/javascript&quot; src=&quot;${page.url.context}/someco/components/rules/config/rule-config-action-custom.js&quot;&gt;&lt;/@script&gt; </code></pre>
<p>Okay, at this point, the rule form will be looking for a custom client-side JavaScript component called SomeCo.RuleConfigActionCustom, the action will show up in the right place, and the page's “&lt;head&gt;” element will include a reference to the custom client-side JavaScript file where the component will reside. It's time to implement the client-side JavaScript.</p>
<h3 id="step-3-implement-the-custom-client-side-javascript-component"><a href="#step-3-implement-the-custom-client-side-javascript-component">Step 3: Implement the custom client-side JavaScript component</a></h3>
<p>The FreeMarker files have been modified to include a reference to a file called rule-config-action-custom.js. By convention, I include client-side JavaScript in my Eclipse project under “src/web/someco”. Alfresco has their rule-related client-side JavaScript under “components/rules/config” so I used the same folder structure.</p>
<p>The first thing the rule-config-action-custom.js file does is declare a SomeCo namespace. It is important that you namespace everything in Alfresco to avoid collisions with Alfresco's code or other add-ons you might install.</p>
<pre><code>if (typeof SomeCo == &quot;undefined&quot; || !SomeCo)
{
   var SomeCo = {};
}</code></pre>
<p>Next, comes the constructor for the component (I've left out some boring stuff, check the source for the full listing):</p>
<pre><code>SomeCo.RuleConfigActionCustom = function(htmlId)
{
   SomeCo.RuleConfigActionCustom.superclass.constructor.call(this, htmlId);

   // Re-register with our own name
   this.name = &quot;SomeCo.RuleConfigActionCustom&quot;;
   Alfresco.util.ComponentManager.reregister(this);

   // Instance variables
   this.customisations = YAHOO.lang.merge(this.customisations, SomeCo.RuleConfigActionCustom.superclass.customisations);
   this.renderers = YAHOO.lang.merge(this.renderers, SomeCo.RuleConfigActionCustom.superclass.renderers);
   
   return this;
};</code></pre>
<p>If this is your first foray into the world of object-oriented client-side JavaScript, relax. What, you thought just because “Java” and “JavaScript” have a word in common that object inheritance would work the same way? How literal of you! Basically, what's going on here is that the constructor is calling its superclass constructor, then it is registering itself with the Alfresco component manager. The YUI merge calls provide a way to avoid re-typing a bunch of code that exists in the parent class.</p>
<p>The final bit is where the extend actually happens, and the MoveReplaced handler is defined:</p>
<pre><code>YAHOO.extend(SomeCo.RuleConfigActionCustom, Alfresco.RuleConfigAction,
{

   /**
    * CUSTOMISATIONS
    */

   customisations:
   {         
      MoveReplaced:
      {
         text: function(configDef, ruleConfig, configEl)
         {
              // Display as path
              this._getParamDef(configDef, &quot;destination-folder&quot;)._type = &quot;path&quot;;
              return configDef;
         },
         edit: function(configDef, ruleConfig, configEl)
         {
             // Hide all parameters since we are using a cusotm ui but set default values
             this._hideParameters(configDef.parameterDefinitions);

             // Make parameter renderer create a &quot;Destination&quot; button that displays an destination folder browser
             configDef.parameterDefinitions.push({
                type: &quot;arca:destination-dialog-button&quot;,
                displayLabel: this.msg(&quot;label.to&quot;),
                _buttonLabel: this.msg(&quot;button.select-folder&quot;),
                _destinationParam: &quot;destination-folder&quot;
             });
             return configDef;
         }
      },
   },

});</code></pre>
<p>This part is a copy of the out-of-the-box handler for Move with the object renamed to MoveReplaced. The MoveReplaced object has two methods: text and edit. Text is what is displayed for the component in read mode. Edit is for edit mode. The edit method is what is responsible for generating the button that invokes the folder picker. In this case, edit leverages an existing renderer called “arca:destination-dialog-button” that is defined in the superclass. If you needed to produce markup for a parameter for which Alfresco doesn't already have a renderer, you would add the appropriate code to the renderers object.</p>
<p>With this final step in place, end-users can configure a rule that invokes the Move Replaced action. The rule editor will use the custom handler for the action so that a folder picker dialog is used to select the target folder.</p>
<p>You can see this happening in the screenshot below. You can see the dialog that gets launched when the Select button is clicked as well as the little folder icon and folder path that are rendered once a selection is made.</p>
<div class="figure">
<img src="./images/move-replaced-config-share.png" alt="Configuring the Move Replaced action in Share" /><p class="caption">Configuring the Move Replaced action in Share</p>
</div>
<h2 id="configuring-the-set-web-flag-ui-action-in-share"><a href="#configuring-the-set-web-flag-ui-action-in-share">Configuring the Set Web Flag UI Action in Share</a></h2>
<p>Now it is time to shift focus from rule actions to UI actions. SomeCo wants end-users to be able to click an item in the menu that either enables or disables the web flag. Alfresco 4 has a framework that allows you to easily add new UI actions to the menu. You can configure:</p>
<ul>
<li>UI actions that call a web page (external or within Share),</li>
<li>UI actions that invoke rule actions on the repository tier that take no parameters,</li>
<li>UI actions that invoke rule actions on the repository tier that launch a dialog to gather parameters before passing those parameters to an action on the repository tier,</li>
<li>UI actions that call arbitrary client-side JavaScript action handlers.</li>
</ul>
<p>Recall that the Set Web Flag action takes one parameter—the value of the active flag. I could use the action framework out-of-the-box to invoke a dialog that lets the user set the action flag to true or false and then call the set web flag action. But that doesn't meet the single-click requirement, and a form is overkill to grab one boolean value.</p>
<p>If you look in the list above, you'll see there isn't an option to hardcode arbitrary parameters in the action config when the action is called. So we're forced to either call a custom client-side JavaScript action handler or add new actions to the repository tier that don't take parameters. There's no “right” answer here—it's just a matter of where you want to write the code. At some point, Alfresco will probably enhance the framework to meet this use case. Until then, for this example, I'm going to go the “no parameter” route, which means I'll have to add two new actions on the repository tier that don't require parameters to be passed in.</p>
<p>So, the steps to follow for this example are:</p>
<ol style="list-style-type: decimal">
<li>Create two new repository tier actions that take no parameters</li>
<li>Update share-config-custom.xml with the action configuration</li>
<li>Create icons and localize the strings</li>
</ol>
<h3 id="step-1-create-two-new-repository-tier-actions"><a href="#step-1-create-two-new-repository-tier-actions">Step 1: Create two new repository tier actions</a></h3>
<p>You created action executer classes in Part 1 of this tutorial so this is nothing new. There needs to be one action for enabling the active flag and one for disabling it and neither should take a parameter. By sub-classing the existing SetWebFlag action, code can be kept to a minimum. Here's the EnableWebFlag action executer in its entirety:</p>
<pre><code>public class EnableWebFlag extends SetWebFlag {
    @Override
    protected void executeImpl(Action action, NodeRef actionedUponNodeRef) {
        action.setParameterValue(SetWebFlag.PARAM_ACTIVE, true);
        super.executeImpl(action, actionedUponNodeRef);
    }
}</code></pre>
<p>The DisableWebFlag action looks just like this but sets the active flag to false. I won't repeat it here.</p>
<p>The Spring configuration for the action is similarly short:</p>
<pre><code>&lt;bean id=&quot;enable-web-flag&quot; class=&quot;com.someco.action.executer.EnableWebFlag&quot; parent=&quot;set-web-flag&quot;&gt;
    &lt;property name=&quot;publicAction&quot;&gt;
        &lt;value&gt;false&lt;/value&gt;
    &lt;/property&gt;
&lt;/bean&gt;</code></pre>
<p>Again, I'm leaving out the disable-web-flag bean but it looks just like this one with a different class. Setting the “publicAction” property to false hides these actions from the action dropdowns. There's no real reason to do that, in this case—it's just an example.</p>
<h3 id="step-2-update-share-config-custom.xml-with-the-action-configuration"><a href="#step-2-update-share-config-custom.xml-with-the-action-configuration">Step 2: Update share-config-custom.xml with the action configuration</a></h3>
<p>The next step is to configure the Share user interface to show the UI actions in the document library and document details menus. While we're at it, I'm going to also drop in a UI action that calls a web page just for kicks.</p>
<p>The action config has moved to share-config-custom.xml in Alfresco 4. Action configuration consists of two parts. The “actions” element contains a list of action definitions. The “actionGroups” element contains a list of action groups. Action groups are things like the list of actions shown in the document library document list or the document details page.</p>
<p>Actions and action groups live in the “DocLibActions” config within share-config-custom.xml. Here are the action definitions for the web site action and web enable:</p>
<pre><code>&lt;!-- Actions --&gt;
&lt;config evaluator=&quot;string-compare&quot; condition=&quot;DocLibActions&quot;&gt;
    &lt;actions&gt;
        &lt;action id=&quot;someco-web-site&quot; type=&quot;link&quot; label=&quot;actions.someco.web-site&quot; icon=&quot;someco-website&quot;&gt;
            &lt;param name=&quot;href&quot;&gt;http://ecmarchitect.com&lt;/param&gt;
            &lt;param name=&quot;target&quot;&gt;_blank&lt;/param&gt;
        &lt;/action&gt;
        &lt;action id=&quot;someco-web-enable&quot; type=&quot;javascript&quot; label=&quot;actions.someco.web-enable&quot; icon=&quot;someco-create-website&quot;&gt;
            &lt;param name=&quot;function&quot;&gt;onActionSimpleRepoAction&lt;/param&gt;
            &lt;permissions&gt;
                &lt;permission allow=&quot;true&quot;&gt;Write&lt;/permission&gt;
            &lt;/permissions&gt;
            &lt;param name=&quot;action&quot;&gt;enable-web-flag&lt;/param&gt;
            &lt;param name=&quot;successMessage&quot;&gt;message.web-flag.enabled&lt;/param&gt;
            &lt;param name=&quot;failureMessage&quot;&gt;message.web-flag.failure&lt;/param&gt;
        &lt;/action&gt;</code></pre>
<p>The “someco-web-site” action is really simple. It is a “link” type of an action, which means it is invoking a URL that is provided in a parameter. The labels and icons will get set up in the next step.</p>
<p>The “someco-web-enable” action is a little more involved. It is a “javascript” action, which means it is calling a client-side JavaScript handler. What's cool is that Alfresco has already provided a client-side handler called “onSimpleRepoAction”. It just needs to know the name of the repository tier action to invoke (the ones created in Step 1) and messages to display on success and failure.</p>
<p>I've left out “someco-web-disable” because it is so similar.</p>
<p>This action uses the built-in onActionSimpleRepoAction, but what if you needed to gather parameters from the end-user before calling the action? For that you can use onActionFormDialog. The itemId specifies a form ID corresponding to a form defined in share-form-config-custom.xml. Take a look at the document-transform action as an example.</p>
<p>The last part of the config is the action definitions. This slots the actions into the appropriate groups:</p>
<pre><code>    &lt;actionGroups&gt;
        &lt;actionGroup id=&quot;document-browse&quot;&gt;
            &lt;action index=&quot;500&quot; id=&quot;someco-web-site&quot; /&gt;
            &lt;action index=&quot;510&quot; id=&quot;someco-web-enable&quot; /&gt;
            &lt;action index=&quot;520&quot; id=&quot;someco-web-disable&quot; /&gt;                
        &lt;/actionGroup&gt;
        &lt;actionGroup id=&quot;document-details&quot;&gt;
            &lt;action index=&quot;500&quot; id=&quot;someco-web-site&quot; /&gt;
            &lt;action index=&quot;510&quot; id=&quot;someco-web-enable&quot; /&gt;
            &lt;action index=&quot;520&quot; id=&quot;someco-web-disable&quot; /&gt;                
        &lt;/actionGroup&gt;
    &lt;/actionGroups&gt;
&lt;/config&gt;</code></pre>
<p>There are a couple of things to note about the action configuration. First, you don't have to copy in the out-of-the-box actions and action groups. They will get merged in. Second, the order of the action items in the list can be controlled by setting the index attribute. The higher the index, the lower in the list the menu items appear.</p>
<h3 id="step-3-create-icons-and-localize-the-strings"><a href="#step-3-create-icons-and-localize-the-strings">Step 3: Create icons and localize the strings</a></h3>
<p>The last step is to provide some icons for the actions and localize the action labels. In step 2 the action element had an “icon” attribute. Alfresco will look in a path for an icon that starts with that name and ends with “-16.png”. Entirely lacking in graphics skills, I grabbed a couple of out-of-the-box icons that looked somewhat applicable and copied them in to my project under “src/web/components/documentlibrary/actions”. Because this is Alfresco's folder structure, I made sure to name the icons starting with “someco” so they would not be confused with others.</p>
<p>The localized strings can go in the existing scModel.properties file. Here they are:</p>
<pre><code>#actions
actions.someco.web-site=SomeCo
actions.someco.web-enable=SC Enable Web
actions.someco.web-disable=SC Disable Web
message.web-flag.enabled=Successfully enabled the SomeCo active flag
message.web-flag.disabled=Successfully disabled the SomeCo active flag
message.web-flag.failure=Error setting the SomeCo active flag</code></pre>
<p>With icons and localized strings in place, you could deploy and run and everything should work. (If you are following along, don't forget to deploy both the repository tier project and the share tier project because you made changes in both).</p>
<p>But, what you'll notice is that both the Enable and Disable UI actions show up at the same time, which is lame. The enable should only show up when the active flag is not set to true. The disable should only show up when the active flag is set to true. That's easy to fix with an evaluator and that's covered in the next section.</p>
<h2 id="finishing-touches-evaluators-indicators"><a href="#finishing-touches-evaluators-indicators">Finishing Touches: Evaluators &amp; Indicators</a></h2>
<p>If you are writing a UI action that should show up all of the time, you don't need to do anything else. But hiding a UI action based on certain conditions is a pretty common requirement. In this example, the UI action needs to hide based on a metadata value. Alfresco has several “evaluators” that can be leveraged out-of-the-box to do this. You can hide UI actions based on things like:</p>
<ul>
<li>The presence of an aspect</li>
<li>The type of a node</li>
<li>Mimetype</li>
<li>The type of site the document library is sitting in</li>
<li>The name of the site</li>
</ul>
<p>Evaluators can also be chained together if multiple conditions need to apply. The out-of-the-box evaluators live in slingshot-document-library-context.xml so refer to that file for the full list of evaluators and an example of how chaining works. You can also write completely new evaluators using Java deployed to the Share tier.</p>
<p>For this example, the out-of-the-box “value” evaluator will do quite nicely. The steps, then, will be as follows:</p>
<ol style="list-style-type: decimal">
<li>Declare a new evaluator in Spring config that extends the “value” evaluator</li>
<li>Update the action config in share-config-custom.xml to point to the evaluator</li>
</ol>
<p>Alfresco 4 has also made it easy to configure “indicators”, which are little icons in the document library column. This isn't entirely relevant to the subject at hand, but because they work just like evaluators and because it makes it easy to see from the document library which content has the active flag set, I'm going to add a third step:</p>
<ol start="3" style="list-style-type: decimal">
<li>Update the share-config-custom.xml file to show a document library indicator</li>
</ol>
<p>After these steps are complete, the UI actions will show or hide themselves appropriately and end-users will be able to see documents with the active flag set to true from the document list.</p>
<h3 id="step-1-declare-a-new-evaluator-in-spring-config"><a href="#step-1-declare-a-new-evaluator-in-spring-config">Step 1: Declare a new evaluator in Spring config</a></h3>
<p>Only one evaluator is needed for this example. The evaluator just needs to know the value of the active flag—the UI actions can show or hide themselves based on that. Evaluators live in Spring config and Spring config resides in files ending with “context.xml”. This project already has “custom-slingshot-application-context.xml” so I added the evaluator to that file:</p>
<pre><code>&lt;bean id=&quot;someco.evaluator.doclib.action.isActive&quot; parent=&quot;evaluator.doclib.action.value&quot;&gt;
    &lt;property name=&quot;accessor&quot; value=&quot;node.properties.sc:isActive&quot; /&gt;
    &lt;property name=&quot;comparator&quot;&gt;
        &lt;bean class=&quot;org.alfresco.web.evaluator.StringEqualsComparator&quot;&gt;
            &lt;property name=&quot;value&quot; value=&quot;true&quot; /&gt;
        &lt;/bean&gt;
    &lt;/property&gt;
&lt;/bean&gt;</code></pre>
<p>This bean extends the out-of-the-box “value” evaluator and provides properties specific to our needs. In this case, the “accessor” is the name of the property the evaluator needs to inspect. The comparator does a string comparison against the value of “true”. Note the use of “someco” in the bean ID. This is another place where you want to make sure you are using your own namespace.</p>
<p>All evaluators work similarly. If you wanted to check for a specific aspect, for example, you would extend the aspect evaluator and then specify the aspect you are looking for in one of the properties.</p>
<h3 id="step-2-update-the-action-config-in-share-config-custom.xml"><a href="#step-2-update-the-action-config-in-share-config-custom.xml">Step 2: Update the action config in share-config-custom.xml</a></h3>
<p>With an evaluator declared the next step is to tell the action configuration which evaluator to use to decide whether or not to show the UI action. So, back over in share-config-custom.xml, I've made the following modifications, highlighted in bold:</p>
<pre><code>        &lt;action id=&quot;someco-web-enable&quot; type=&quot;javascript&quot; label=&quot;actions.someco.web-enable&quot; icon=&quot;someco-create-website&quot;&gt;
            &lt;param name=&quot;function&quot;&gt;onActionSimpleRepoAction&lt;/param&gt;
            &lt;permissions&gt;
                &lt;permission allow=&quot;true&quot;&gt;Write&lt;/permission&gt;
            &lt;/permissions&gt;
            &lt;param name=&quot;action&quot;&gt;enable-web-flag&lt;/param&gt;
            &lt;param name=&quot;successMessage&quot;&gt;message.web-flag.enabled&lt;/param&gt;
            &lt;param name=&quot;failureMessage&quot;&gt;message.web-flag.failure&lt;/param&gt;
            &lt;evaluator negate=&quot;true&quot;&gt;someco.evaluator.doclib.action.isActive&lt;/evaluator&gt;
        &lt;/action&gt;
        &lt;action id=&quot;someco-web-disable&quot; type=&quot;javascript&quot; label=&quot;actions.someco.web-disable&quot; icon=&quot;someco-delete-website&quot;&gt;
            &lt;param name=&quot;function&quot;&gt;onActionSimpleRepoAction&lt;/param&gt;
            &lt;permissions&gt;
                &lt;permission allow=&quot;true&quot;&gt;Write&lt;/permission&gt;
            &lt;/permissions&gt;
            &lt;param name=&quot;action&quot;&gt;disable-web-flag&lt;/param&gt;
            &lt;param name=&quot;successMessage&quot;&gt;message.web-flag.disabled&lt;/param&gt;
            &lt;param name=&quot;failureMessage&quot;&gt;message.web-flag.failure&lt;/param&gt;
            &lt;evaluator&gt;someco.evaluator.doclib.action.isActive&lt;/evaluator&gt;
        &lt;/action&gt;</code></pre>
<p>Both actions use the same evaluator. For the someco-web-enable action, the evaluator is negated. So if the evaluator returns true (i.e., the sc:isActive property is set to true) the web enable action will be hidden. If the evaluator returns false, the action will show itself.</p>
<h3 id="step-3-update-the-share-config-custom.xml-file-to-show-a-document-library-indicator"><a href="#step-3-update-the-share-config-custom.xml-file-to-show-a-document-library-indicator">Step 3: Update the share-config-custom.xml file to show a document library indicator</a></h3>
<p>The last step is really not needed at all if all you are doing is adding an action to the menu. But because it is easy to do and leverages the same evaluator written in the previous step, I didn't think you'd mind.</p>
<p>The goal here is to show a little icon in the document library only if the “sc:isActive” property is set to true. If you are already thinking, “Hey, that sounds like an evaluator!” you've got it.</p>
<p>Indicators are part of the “DocumentLibrary” config in share-config-custom.xml. All it needs is a pointer to an evaluator. In this case, the one created earlier can be reused:</p>
<pre><code>    &lt;/types&gt;
    
    &lt;!-- Custom Indicators --&gt;
    &lt;indicators&gt;
        &lt;indicator id=&quot;someco-website&quot; index=&quot;10&quot;&gt;
            &lt;evaluator&gt;someco.evaluator.doclib.action.isActive&lt;/evaluator&gt;
        &lt;/indicator&gt;
    &lt;/indicators&gt;
&lt;/config&gt;</code></pre>
<p>Alfresco will use the indicator's id attribute appended with “-16.png” for the icon. I copied the same icon used for the “enable” action into “src/web/components/documentlibrary/indicators” for this purpose.</p>
<h3 id="deploy-test"><a href="#deploy-test">Deploy &amp; Test</a></h3>
<p>If you've been following along and you've waited to deploy until now, it's time to try it out. The code that accompanies this article includes an Ant build file in each of the two projects. And each project includes a build.properties file. The repository project's build.properties file needs to know the location of the expanded Alfresco SDK and the location of the expanded Alfresco webapp root. The Share project's build.properties file needs to know the location of the expanded Share webapp root and the location of the YUI compressor JAR, which is used as part of the build process. Once those are set, you should be able to run “ant deploy” for each of the two projects, start Tomcat, and test.</p>
<p>If everything is working correctly, you should see the SomeCo web site link and either the SC Web Enable or the SC Web Disable menu items from both the browse menu and the details page as shown below.</p>
<div class="figure">
<img src="./images/indicators-browse-share.png" alt="Indicators show which content has the active flag set in Share" /><p class="caption">Indicators show which content has the active flag set in Share</p>
</div>
<div class="figure">
<img src="./images/ui-actions-disable-details-share.png" alt="Custom UI actions in the document details page" /><p class="caption">Custom UI actions in the document details page</p>
</div>
<div class="figure">
<img src="./images/ui-actions-disable-browse-share.png" alt="Custom UI actions in the document list" /><p class="caption">Custom UI actions in the document list</p>
</div>
<p>Clicking the “SomeCo” menu item will open a browser window to the URL specified in the configuration. Clicking the “SC Disable Web” should invoke the action on the repository tier and then refresh the metadata and the action list.</p>
<h1 id="conclusion"><a href="#conclusion">Conclusion</a></h1>
<p>This article has shown how actions can be used to implement reusable operations that can be run against content in the repository. Those actions can be called from code using the Action Service and they can be invoked from the user interface by configuring rules or by setting up UI actions and placing those alongside other menu items in places like the document list and the details page. Hopefully it has sparked some ideas about how you could use custom actions in your next Alfresco implementation.</p>
<h2 id="where-to-find-more-information"><a href="#where-to-find-more-information">Where to find more information</a></h2>
<ul>
<li>All source code used in this example is available <a href="http://ecmarchitect.com/images/articles/alfresco-actions/alfresco-actions-tutorial.zip">here</a>.</li>
<li>The <a href="http://wiki.alfresco.com/wiki/Community_file_list_4.0.c">Alfresco SDK</a> comes with a Custom Action example.</li>
<li>Official documentation for both Enterprise and Community is available at <a href="http://docs.alfresco.com/">docs.alfresco.com</a>.</li>
<li><a href="http://code.google.com/p/share-extras/">Share Extras</a> has many examples of deeper Share customization as well as <a href="http://sharextras.org/jsdoc/share/">documentation</a> of Alfresco's client-side JavaScript components.</li>
<li><a href="http://blogs.alfresco.com/wp/mikeh/">Mike Hatfield</a> and <a href="http://blogs.alfresco.com/wp/ddraper/">David Draper</a> are two examples of Alfresco engineer blogs that are extremely useful if you are customizing Share.</li>
<li>For deployment help, see <a href="http://wiki.alfresco.com/wiki/Packaging_And_Deploying_Extensions">Packaging and Deploying Extensions</a> in the Alfresco wiki.</li>
<li>For general development help, see the <a href="http://wiki.alfresco.com/wiki/Developer_Guide">Developer Guide</a>.</li>
<li>For help customizing the data dictionary, see the <a href="http://wiki.alfresco.com/wiki/Data_Dictionary_Guide">Data Dictionary</a> wiki page.</li>
<li>If you are ready to cover new ground, try another <a href="http://ecmarchitect.com/">ecmarchitect.com</a> tutorial in the <a href="http://ecmarchitect.com/alfresco-developer-series">Alfresco</a><a href="http://ecmarchitect.com/alfresco-developer-series">Developer Series</a>.</li>
</ul>
<h1 id="appendix"><a href="#appendix">Appendix</a></h1>
<p>Not everyone is able to use Alfresco Share as their user interface. The sections within this Appendix show you how to do the same thing Part 2 covers, but uses Alfresco Explorer instead of Alfresco Share.</p>
<h2 id="configuring-the-replaceable-aspect-in-explorer"><a href="#configuring-the-replaceable-aspect-in-explorer">Configuring the Replaceable Aspect in Explorer</a></h2>
<p>Alfresco's out-of-the-box content model contains an aspect called “cm:replaceable” but it is not exposed in the UI. End-users need to be able to declare which documents a new document should replace, so the aspect will need to be added to the web-client-config-custom.xml file created in the content types tutorial.</p>
<p>The “aspects” element should now look like this:</p>
<pre><code>&lt;aspects&gt;
        &lt;aspect name=&quot;sc:webable&quot;/&gt;
        &lt;aspect name=&quot;sc:productRelated&quot;/&gt;
        &lt;aspect name=&quot;cm:replaceable&quot;/&gt;
&lt;/aspects&gt;</code></pre>
<p>And a new “config” element tells the user interface to show the “cm:replaces” relationship:</p>
<pre><code>&lt;config evaluator=&quot;aspect-name&quot; condition=&quot;cm:replaceable&quot;&gt;
    &lt;property-sheet&gt;
        &lt;show-association name=&quot;cm:replaces&quot; display-label-id=&quot;replaces&quot; /&gt;
    &lt;/property-sheet&gt;
&lt;/config&gt;</code></pre>
<p>With this configuration in place, end-users can edit a document's metadata to maintain the “replaces” relationship.</p>
<h2 id="configuring-the-move-replaced-rule-action-in-explorer"><a href="#configuring-the-move-replaced-rule-action-in-explorer">Configuring the Move Replaced Rule Action in Explorer</a></h2>
<p>The back-end logic for the Move Replaced Action was implemented in Part 1. If users are going to specify parameters for an action when configuring it as part of a rule or when invoking it via “Run Action”, a user interface has to be provided. This is done by:</p>
<ol style="list-style-type: decimal">
<li>Create an action handler class</li>
<li>Create a corresponding JSP page</li>
<li>Localize the strings.</li>
</ol>
<h3 id="step-1-create-an-action-handler-class"><a href="#step-1-create-an-action-handler-class">Step 1: Create an action handler class</a></h3>
<p>Alfresco's bean handler class for the Move action is called org.alfresco.web.bean.actions.handlers.MoveHandler and it resides in the Alfresco source in the Web Client project. The bean handler class handles the &quot;view&quot; for the action configuration. Because both the &quot;Move&quot; action and our &quot;Move Replaced&quot; action both have a destination folder and no other configurable properties, only minor modifications are needed to make it work for the new action.</p>
<p>First, the custom action will have its own JSP for the presentation so the getJSPPath() method needs to change from this:</p>
<pre><code>public String getJSPPath() {
    return getJSPPath(MoveActionExecuter.NAME);
}</code></pre>
<p>to this:</p>
<pre><code>public final static String CUSTOM_ACTION_JSP = &quot;/someco/jsp/actions/&quot; + MoveReplacedActionExecuter.NAME + &quot;.jsp&quot;;

public String getJSPPath() {
    return CUSTOM_ACTION_JSP;
}</code></pre>
<p>All I'm doing here is telling the bean where to find our customized JSP.</p>
<p>Next, if you've ever configured an action before you know that the user interface includes a short summary of what the action is going to do. The generateSummary() method is responsible for that message. The actual text will be in a resource bundle, so I changed the property name from &quot;action_move&quot; to &quot;action_move_replaced&quot;.</p>
<h3 id="step-2-create-a-corresponding-jsp-page"><a href="#step-2-create-a-corresponding-jsp-page">Step 2: Create a corresponding JSP page</a></h3>
<p>The JSP page that handles the move configuration for Move Replaced is identical to the out-of-the-box move. But the title needs to be different, so it requires its own page. And, because the page is in a different folder structure than the Alfresco JSP, the existing JSP includes will need to be updated because they use relative links.</p>
<p>Copy &quot;/source/web/jsp/actions/move.jsp&quot; from the Alfresco Web Client project into the custom repository project. I use &quot;src/web/{namespace}/jsp&quot; for all customized Alfresco JSPs by convention, so the full path to the JSP in the custom project is, &quot;src/web/someco/jsp/actions/move-replaced.jsp&quot;. The customized JSPs will be deployed to a different directory structure so any existing relative links that need to point to out-of-the-box JSPs need to point to “/jsp/parts/*”. In this case there are three includes that I updated as follows:</p>
<pre><code>        &lt;%@ include file=&quot;/jsp/parts/titlebar.jsp&quot; %&gt;
        &lt;%@ include file=&quot;/jsp/parts/shelf.jsp&quot; %&gt;
        &lt;%@ include file=&quot;/jsp/parts/breadcrumb.jsp&quot; %&gt;</code></pre>
<p>To point to the custom title property in the resource bundle, I changed the titleId attribute of the r:page tag from &quot;title_action_move&quot; to &quot;title_action_move_replaced&quot;.</p>
<p>That's it for the Java and JSP code. Now it is time to localize the action.</p>
<h3 id="step-3-localize-the-move-replaced-action"><a href="#step-3-localize-the-move-replaced-action">Step 3: Localize the Move Replaced Action</a></h3>
<p>The someco-action-context.xml file needs to be updated to point to a resource bundle. I added the following to that file:</p>
<pre><code>&lt;bean id=&quot;someco.actionResourceBundles&quot; parent=&quot;actionResourceBundles&quot;&gt;
    &lt;property name=&quot;resourceBundles&quot;&gt;
        &lt;list&gt;
            &lt;value&gt;alfresco.extension.messages.somecoactions&lt;/value&gt;
        &lt;/list&gt;
    &lt;/property&gt;
&lt;/bean&gt;</code></pre>
<p>Next, I need to create a resource bundle so I created a file in alfresco/extension/messages called somecoactions.properties. Note that this file name and path matches the resource bundle declaration from the previous step.</p>
<pre><code>##
## SomeCo Actions I18N file
##

# Move Replaced action
move-replaced.title=Move replaced document to space
move-replaced.description=This will move the target node of a replaces association to a specified space.</code></pre>
<p>The summary text and the JSP title get pulled from alfresco/extension/webclient.properties. The “cm:replaces” aspect also needs to be localized. So, I added the following entries to the file:</p>
<pre><code>#cm:replaceable
replaces=Replaces

#Move Replaced Action
action_move_replaced=Move replaced to &#39;&#39;{0}&#39;&#39;
title_action_move_replaced=Move Replaced Action</code></pre>
<p>The last step is to hook in to the Alfresco action wizard UI so that when someone configures a rule or simple workflow, the new action is listed as a valid choice. I edited the alfresco/extension/web-client-config-custom.xml file and added the following:</p>
<pre><code>&lt;!-- action handlers --&gt;
&lt;config evaluator=&quot;string-compare&quot; condition=&quot;Action Wizards&quot;&gt;
    &lt;!-- add custom action handler for &quot;Move Replaced&quot; action --&gt;
    &lt;action-handlers&gt;
        &lt;handler name=&quot;move-replaced&quot; class=&quot;com.someco.action.handler.MoveReplacedHandler&quot; /&gt;
    &lt;/action-handlers&gt;
&lt;/config&gt;</code></pre>
<p>The code that accompanies this document includes a sample Ant build.xml file that can be used to deploy the files to the right spot within the Alfresco WAR. In real life, you'll want to package your extensions as an AMP and then use the Module Management Tool (MMT) to merge the AMP with the Alfresco WAR. For local development and testing, the Ant's deploy, which essentially does a copy into the exploded webapp, will be fine.</p>
<p>To set up a test, you'll need to add the replaceable aspect to a piece of test content. After the aspect has been applied, you should see a &quot;replaces&quot; section in the document's properties. If not, double-check the web-client-config-custom.xml file. Edit the properties and select a document to replace. This establishes the &quot;replaces&quot; association.</p>
<p>Now add a rule to the space in which &quot;Published&quot; documents reside. The rule should run the new &quot;Move Replaced&quot; action.</p>
<div class="figure">
<img src="./images/move-replaced-config-explorer.png" alt="Select the custom move replaced action" /><p class="caption">Select the custom move replaced action</p>
</div>
<p>Configure the action to move documents to the &quot;Archived&quot; space.</p>
<div class="figure">
<img src="./images/move-replaced-config-explorer3.png" alt="Configure the target folder for the action" /><p class="caption">Configure the target folder for the action</p>
</div>
<p>To test the logic, paste the document with the &quot;replaces&quot; association into the &quot;Published&quot; space. The document it is replacing should get automatically moved to the &quot;Archived&quot; folder.</p>
<h2 id="configuring-the-set-web-flag-ui-action-in-explorer"><a href="#configuring-the-set-web-flag-ui-action-in-explorer">Configuring the Set Web Flag UI Action in Explorer</a></h2>
<p>The Set Web Flag action isn't meant to be called from a rule so it does not have a Handler class or a JSP. It will be called from a menu item in the Explorer user interface. These menu items are often called “UI actions”.</p>
<p>Assuming the back-end action already exists, the steps to integrate it into the Explorer user interface are:</p>
<ol style="list-style-type: decimal">
<li>Create a JSF-managed bean</li>
<li>Update web-client-config-custom.xml</li>
<li>Localize the action</li>
</ol>
<h3 id="step-1-create-a-jsf-managed-bean"><a href="#step-1-create-a-jsf-managed-bean">Step 1: Create a JSF-managed Bean</a></h3>
<p>The WebSettingsBean class gets called when the UI action is clicked. Here is a snippet from the bean's setActive method:</p>
<pre><code>final NodeRef ref = new NodeRef(Repository.getStoreRef(), id);
RetryingTransactionHelper txnHelper = Repository.getRetryingTransactionHelper(fc);
RetryingTransactionCallback&lt;Object&gt; callback = new RetryingTransactionCallback&lt;Object&gt;() {
    public Object execute() throws Throwable {
        ActionImpl action = new ActionImpl(ref, SetWebFlag.NAME, null);
        action.setParameterValue(SetWebFlag.PARAM_ACTIVE, activeFlag);
        SetWebFlag actionExecuter = (SetWebFlag) FacesContextUtils.getWebApplicationContext(fc).getBean(SetWebFlag.NAME);
        actionExecuter.execute(action, ref);
                    
        String msg = Application.getMessage(fc, MSG_SUCCESS_WEB_SET_ACTIVE);
        FacesMessage facesMsg = new FacesMessage(FacesMessage.SEVERITY_INFO, msg, msg);
        String formId = Utils.getParentForm(fc,
            event.getComponent()).getClientId(fc);
        FacesContext.getCurrentInstance().addMessage(formId + &#39;:&#39; + PANEL_ID_SPACE_PROPS, facesMsg);
        return null;
    }
};
txnHelper.doInTransaction(callback);
this.browseBean.getDocument().reset();</code></pre>
<p>This snippet shows a transaction being set up before instantiating and executing the SetWebFlag action executer class. The rest of the code deals with providing the user some feedback after the action runs.</p>
<p>Once the class is complete it has to be wired in to JavaServer Faces. This is done by creating a file called faces-config-context.xml in WEB-INF with the following content:</p>
<pre><code>&lt;?xml version=&#39;1.0&#39; encoding=&#39;UTF-8&#39;?&gt;
&lt;!DOCTYPE faces-config PUBLIC &quot;-//Sun Microsystems, Inc.//DTD JavaServer Faces Config 1.1//EN&quot;
                              &quot;http://java.sun.com/dtd/web-facesconfig_1_1.dtd&quot;&gt;
&lt;faces-config&gt;

    &lt;managed-bean&gt;    
        &lt;description&gt;
            The bean that manages SC Web settings.
        &lt;/description&gt;
        &lt;managed-bean-name&gt;WebSettingsBean&lt;/managed-bean-name&gt;
        &lt;managed-bean-class&gt;com.someco.web.bean.WebSettingsBean&lt;/managed-bean-class&gt;
        &lt;managed-bean-scope&gt;session&lt;/managed-bean-scope&gt;
        &lt;managed-property&gt;
            &lt;property-name&gt;browseBean&lt;/property-name&gt;
            &lt;value&gt;#{BrowseBean}&lt;/value&gt;
        &lt;/managed-property&gt;
    &lt;/managed-bean&gt;
    
&lt;/faces-config&gt;</code></pre>
<p>Now that JSF knows about the new bean it can be wired into the Explorer user interface.</p>
<h3 id="step-2-update-web-client-config-custom.xml-with-the-new-ui-action"><a href="#step-2-update-web-client-config-custom.xml-with-the-new-ui-action">Step 2: Update web-client-config-custom.xml with the new UI action</a></h3>
<p>There are several menus within the Alfresco Explorer user interface. These are called “action groups”. Actions (I'm talking about “UI actions” now) can be defined once and then added to as many action groups as needed. A UI action might call an arbitrary URL, an action (like Set Web Flag), or a Wizard or Dialog. This tutorial doesn't cover wizards and dialogs, but it does provide examples of the first two.</p>
<p>I added the following to web-client-config-custom.xml:</p>
<pre><code>&lt;!-- UI Actions --&gt;
&lt;config&gt;
    &lt;actions&gt;
        &lt;action-group id=&quot;document_browse&quot;&gt;
            &lt;action idref=&quot;web_site&quot; /&gt;
        &lt;/action-group&gt;

        &lt;!-- Actions Menu for a document in the Browse screen --&gt;
        &lt;action-group id=&quot;document_browse_menu&quot;&gt;
            &lt;action idref=&quot;web_site&quot; /&gt;
        &lt;/action-group&gt;

        &lt;!-- Actions Menu for Document Details screen --&gt;
        &lt;action-group id=&quot;doc_details_actions&quot;&gt;
            &lt;action idref=&quot;web_enable&quot; /&gt;
            &lt;action idref=&quot;web_disable&quot; /&gt;
            &lt;action idref=&quot;web_site&quot; /&gt;
        &lt;/action-group&gt;</code></pre>
<p>This part of the configuration adds a “Web Site” menu item to the browse menu, the “more” menu, and the document details screen. It also adds the “Web Enable” and “Web Disable” to the document details screen.</p>
<p>The next part of the configuration defines the UI actions. The first one is a simple action that invokes a URL.</p>
<pre><code>        &lt;!--  Link to SomeCo&#39;s web site --&gt;
        &lt;action id=&quot;web_site&quot;&gt;
            &lt;label&gt;SomeCo&lt;/label&gt;
            &lt;href&gt;http://ecmarchitect.com&lt;/href&gt;
            &lt;image&gt;/someco/images/icons/website.gif&lt;/image&gt;
            &lt;target&gt;new&lt;/target&gt;
        &lt;/action&gt;</code></pre>
<p>The next one enables the “sc:isActive” flag.</p>
<pre><code>        &lt;!--  set sc:isActive to true --&gt;
        &lt;action id=&quot;web_enable&quot;&gt;
            &lt;permissions&gt;
                &lt;!-- each permission can be an Allow or Deny check --&gt;
                &lt;permission allow=&quot;true&quot;&gt;Write&lt;/permission&gt;
            &lt;/permissions&gt;
            &lt;evaluator&gt;com.someco.action.evaluator.WebEnableEvaluator&lt;/evaluator&gt;
            &lt;label-id&gt;enableWeb&lt;/label-id&gt;
            &lt;image&gt;/someco/images/icons/create_website.gif&lt;/image&gt;
            &lt;action-listener&gt;#{WebSettingsBean.setActive}&lt;/action-listener&gt;
            &lt;params&gt;
                &lt;param name=&quot;id&quot;&gt;#{actionContext.id}&lt;/param&gt;
                &lt;param name=&quot;active&quot;&gt;true&lt;/param&gt;   
            &lt;/params&gt;
        &lt;/action&gt;</code></pre>
<p>The “permissions” element points to an out-of-the-box permission called “Write”. I'm assuming anyone with write access to the node is also allowed to publish the content to the web. It might make sense to instead create a custom role, like “PortalPublisher” and use that. Honestly, I had a little bit of trouble getting that to work so I decided to keep it simple for now and use “Write” and will follow up later with how to modify the example to use a custom role.</p>
<p>The “evaluator” element is a Java class discussed in the next section. If you want to deploy and test your action before writing that class, just comment out the evaluator. The “action-listener” refers to the JSF-managed bean created in the previous step. The “params” element passes arguments into the WebSettingsBean.</p>
<p>The final piece of config sets up the menu item to disable the “sc:isActive” flag. It's almost identical to the “enable” case except that it passes a different value for the active flag.</p>
<pre><code>        &lt;!--  set sc:isActive to false --&gt;
        &lt;action id=&quot;web_disable&quot;&gt;
            &lt;permissions&gt;
                &lt;!-- each permission can be an Allow or Deny check --&gt;
                &lt;permission allow=&quot;true&quot;&gt;PortalPublisher&lt;/permission&gt;
            &lt;/permissions&gt;
            &lt;evaluator&gt;com.someco.action.evaluator.WebDisableEvaluator&lt;/evaluator&gt;
            &lt;label-id&gt;disableWeb&lt;/label-id&gt;
            &lt;image&gt;/someco/images/icons/delete_website.gif&lt;/image&gt;
            &lt;action-listener&gt;#{WebSettingsBean.setActive}&lt;/action-listener&gt;
            &lt;params&gt;
                &lt;param name=&quot;id&quot;&gt;#{actionContext.id}&lt;/param&gt;
                &lt;param name=&quot;active&quot;&gt;false&lt;/param&gt;       
            &lt;/params&gt;
        &lt;/action&gt;
    &lt;/actions&gt;
&lt;/config&gt;</code></pre>
<h3 id="step-3-localize-the-set-web-flag-action"><a href="#step-3-localize-the-set-web-flag-action">Step 3: Localize the Set Web Flag action</a></h3>
<p>I localized the action by adding the following to somecoactions.properties:</p>
<pre><code># Set web flag action
set-web-flag.title=Sets the SC Web Flag
set-web-flag.description=This will add the sc:webable aspect and set the isActive flag.</code></pre>
<p>If you deploy now you should see menu items in the right places. And if you click them they should work. You'll notice when looking at the document details page, however, that the “SC Web Enable” and “SC Web Disable” menu items both show up. To reduce confusion and clutter, the enable item should only show when the flag hasn't been set or is set to false and the disable item should only show when the flag has been set to true. Hiding and showing menu items is the job of an “evaluator” and that's the topic of the next section.</p>
<h2 id="configuring-the-evaluator-to-showhide-the-set-web-flag-ui-action-in-explorer"><a href="#configuring-the-evaluator-to-showhide-the-set-web-flag-ui-action-in-explorer">Configuring the Evaluator to Show/Hide the Set Web Flag UI Action in Explorer</a></h2>
<p>The final step in configuring the Set Web Flag action within the Alfresco Explorer user interface is to write an evaluator that hides/shows the menu items appropriately based on the value of the “sc:isActive” flag.</p>
<p>The evaluators have already been specified in the web-client-config-custom.xml. The only thing left to do is to implement the evaluator as a Java class. The WebEnableEvaluator class implements the ActionEvaluator interface. The magic happens within the evaluate method and is as follows:</p>
<pre><code>public boolean evaluate(Node node) {      
    FacesContext context = FacesContext.getCurrentInstance();

    // check the aspect, then check the active property
    NodeRef ref = new NodeRef(Repository.getStoreRef(), node.getId());
    
    // if the aspect hasn&#39;t yet been added, it can be enabled
    if (!node.hasAspect(
            QName.createQName(SomeCoModel.NAMESPACE_SOMECO_CONTENT_MODEL, SomeCoModel.ASPECT_SC_WEBABLE))) {
        return true;
    }
    
    // check the active property
    NodeService nodeSvc = Repository.getServiceRegistry(context).getNodeService();
    boolean active = (Boolean)nodeSvc.getProperty(ref, QName.createQName(SomeCoModel.NAMESPACE_SOMECO_CONTENT_MODEL, SomeCoModel.PROP_IS_ACTIVE));
    
    return !active;
}</code></pre>
<p>This code checks for the presence of the “sc:webable” aspect. It actually doesn't matter if the aspect is there or not—if it isn't, the Set Web Flag action will add it. Then, the evaluator checks the value of the active flag and simply returns the opposite of its value (If the flag is false, return true to show the enable menu item. If the flag is true, return false to hide the enable menu item).</p>
<p>The evaluator for disable is so similar, it doesn't make sense to repeat it here.</p>
<p>On deploying the repository project using “ant deploy” and then restarting Tomcat, you should be able to enable and disable the web flag using the menu items on the document details page. The menu items should only show up for users in the appropriate role, and they should hide themselves based on the value of the active flag.</p>
<div class="figure">
<img src="./images/ui-actions-someco-browse-explorer.png" alt="New UI actions in the browse menu" /><p class="caption">New UI actions in the browse menu</p>
</div>
<div class="figure">
<img src="./images/ui-actions-disable-details-explorer.png" alt="New UI actions in the details menu" /><p class="caption">New UI actions in the details menu</p>
</div>
					</div><!-- .entry-content -->
				</div><!-- #post-## -->
			</div><!-- #content -->
		</div><!-- #container -->
	</div><!-- #main -->
	<div id="footer" role="contentinfo">
		<div id="colophon">
			<div id="site-info">
				<p><a href="http://ecmarchitect.com/"
		title="ECM Architect" rel="home">ECM
		Architect</a></p>
			  
<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.			  
			</div><!-- #site-info -->
		</div><!-- #colophon -->
	</div><!-- #footer -->
<div class="github-fork-ribbon-wrapper right-bottom">
        <div class="github-fork-ribbon">
            <a href="https://github.com/jpotts/alfresco-developer-series">Fork me on GitHub</a>
        </div>
    </div>
</div><!-- header -->
</body>
</html>
