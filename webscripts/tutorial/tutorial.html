<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <link rel="profile" href="http://gmpg.org/xfn/11" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Jeff Potts" />
  <title>Introduction to the Web Script Framework | ECM
Architect | Alfresco Developer Tutorials</title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="../../tutorial-common/style.css" type="text/css" />
</head>
<body class="page page-template page-template-onecolumn-page-php custom-background">
<!--
<div class="github-fork-ribbon-wrapper right">
    <div class="github-fork-ribbon">
            <a href="https://github.com/jpotts/alfresco-developer-series">Fork me on GitHub</a>
    </div>
</div>
-->
<div id="wrapper" class="hfeed">
	<div id="main">
		<div id="container" class="one-column">
			<div id="content" role="main">
				<div id="post" class="post page type-page status-draft hentry">
					<div class="entry-content">
<div id="header">
<h1 class="entry-title">Introduction to the Web Script Framework</h1>
<h2 class="author">Jeff Potts</h2>
<h3 class="date">October, 2007</h3>
</div>
<div id="TOC">
<ul>
<li><a href="#license">License</a></li>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#what-is-the-web-script-framework">What is the Web Script Framework?</a></li>
<li><a href="#examples">Examples</a><ul>
<li><a href="#hello-world-example">Hello World Example</a></li>
</ul></li>
<li><a href="#someco-whitepaper-user-contributed-ratings-examples">SomeCo Whitepaper User-contributed Ratings Examples</a><ul>
<li><a href="#listing-all-whitepapers">Listing all Whitepapers</a><ul>
<li><a href="#sidebar-enabling-a-subset-of-whitepapers-for-web-display">Sidebar: Enabling a subset of whitepapers for web display</a></li>
<li><a href="#organizing-your-code">Organizing your code</a></li>
<li><a href="#step-1-the-descriptor">Step 1: The descriptor</a></li>
<li><a href="#step-2-the-controller">Step 2: The Controller</a></li>
<li><a href="#step-3-the-view">Step 3: The view</a></li>
<li><a href="#debugging">Debugging</a></li>
</ul></li>
<li><a href="#retrieving-the-rating-for-a-whitepaper">Retrieving the Rating for a Whitepaper</a></li>
<li><a href="#posting-a-rating-with-a-java-backed-web-script">Posting a Rating with a Java-backed Web Script</a><ul>
<li><a href="#step-1-business-logic">Step 1: Business logic</a></li>
<li><a href="#step-2-web-script-controller-bean">Step 2: Web script controller bean</a></li>
<li><a href="#step-3-spring-config-for-the-web-script-controller-bean">Step 3: Spring config for the Web script controller bean</a></li>
</ul></li>
<li><a href="#revisiting-the-rating.get.html.ftl-template">Revisiting the rating.get.html.ftl template</a></li>
<li><a href="#deleting-ratings">Deleting ratings</a></li>
<li><a href="#example-summary">Example summary</a></li>
<li><a href="#dealing-with-the-cross-domain-scripting-limitation">Dealing with the cross-domain scripting limitation</a></li>
<li><a href="#deploying-and-testing">Deploying and Testing</a></li>
</ul></li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#where-to-find-more-information">Where to find more information</a></li>
<li><a href="#footnotes">Footnotes</a></li>
</ul>
</div>
<h1 id="license"><a href="#license">License</a></h1>
<div class="figure">
<img src="./images/cc-by-sa-88x31.png" />
</div>
<p>This work is licensed under the Creative Commons Attribution-ShareAlike 3.0 Unported License. To view a copy of this license, visit http://creativecommons.org/licenses/by-sa/3.0/ or send a letter to Creative Commons, 444 Castro Street, Suite 900, Mountain View, California, 94041, USA.</p>
<h1 id="introduction"><a href="#introduction">Introduction</a></h1>
<p>This article is an introduction to the Alfresco Web Script Framework that became available with release 2.1 of the product.</p>
<p>We'll continue to extend the “SomeCo Whitepapers” example started in previous articles. As a quick refresher, in those articles, we extended the out-of-the-box content model so that SomeCo could store custom metadata about one of their document types, whitepapers. We created a custom aspect called rateable that could be attached to any object that was user-rateable. Then, in the custom behavior article we wrote business logic associated with the rateable aspect that knew how to calculate the average user rating for a given piece of content. The calculation was triggered every time a rating was created or deleted. We used server-side JavaScript to create rating objects to test out our behavior but there wasn't an interface available that end users could use to rate whitepapers.</p>
<p>SomeCo is now ready to move to the next step: Exposing the rating functionality to the front-end. In their infinite wisdom, the team at SomeCo realizes that Alfresco's Web Scripts provide a nice way to expose a lightweight, RESTful API for working with whitepapers and ratings. So in this article, we'll roll our own REST API for retrieving a list of whitepapers, retrieving the average rating for a given whitepaper, retrieving a specific rating, posting a new rating for a whitepaper, and deleting all ratings for a given whitepaper. We'll use JavaScript for most of our controller logic but we'll see how to use Java as well. The view will be implemented using FreeMarker templates that return HTML and JSON.</p>
<p>The complete source code that accompanies this article is available at ecmarchitect.com. See the “More Information” section at the end of this article for the link. In addition to the code for this article, the zip includes the code created in the first two “SomeCo” articles so if you don't have to dig around for the code we build upon in this article.</p>
<p>Sound decent? Okay, let's get started.</p>
<h1 id="what-is-the-web-script-framework"><a href="#what-is-the-web-script-framework">What is the Web Script Framework?</a></h1>
<p>Content-centric applications, whether they are inside or outside the firewall, are becoming more and more componentized. I think of this as turning traditional content management approaches inside-out. Rather than having a single, monolithic system responsible for all aspects of a content-centric web application, loosely-coupled sub-systems are being integrated to create more agile solutions.</p>
<p>This approach requires that your content management system have a flexible and lightweight interface. You don't want to be locked in to a presentation approach based on the content repository you are working with. In fact, in some cases, you might have very little control over the tools that will be used to talk to your CMS.</p>
<p>Consider the exploding rate of Next Generation Internet (NGI) solutions, the growing adoption of wikis and blogs within an Enterprise (“Enterprise 2.0”), and the increasing popularity of mash-ups both inside and outside the Enterprise. These trends are driving implementations where the CMS is seen as a black-box component with the front-end (or perhaps many different front-ends) interacting with the CMS and other components via REST.</p>
<p>Among open source content management systems, Alfresco is one of the few that really lends itself to this approach because it has many options for interacting with the repository. These options have evolved over time. The following summarizes ways in which your front-end could work with the Alfresco repository prior to release 2.1:</p>
<ul>
<li><p><strong>Embed the repository</strong>. Alfresco's repository can be embedded in a custom application. Using this approach you have the full power of the Alfresco foundation API. Of course, the downside is that you've just tightly coupled the repository with your application. Didn't we just talk about how important an open, loosely-coupled architecture is? Moving on...</p></li>
<li><p><strong>Web Services</strong>. Alfresco has had a SOAP-based Web Services API available for quite some time, but SOAP-based Web Services have heavier client-side requirements than their RESTful cousins. Some clients found that the out-of-the-box services were too chatty and had too much processing overhead to scale well so they ended up writing their own services and exposing them through the embedded Apache Axis server. So Web Services may not be the right fit in all cases.</p></li>
<li><p><strong>JCR</strong>. The JCR API is a standard way of working with content in a repository and can be leveraged remotely through RMI. This has the benefit of using a standards-based approach for interacting with the repository which theoretically reduces switching costs and makes the application easier to support. One challenge with this approach is that the JCR API may not do everything you need to do so you end up using the JCR in combination with one of the above approaches which reduces the “switching costs” benefit. Another potential issue is that it is Java-only.</p></li>
<li><p><strong>URL Addressability</strong>. Objects in the Alfresco repository are URL-addressable. And, FreeMarker templates and server-side JavaScript can be applied to any node in the repository. So, for example, you can write a FreeMarker template that returns XML or JSON. A front-end app can then post an XMLHttpRequest to Alfresco that specifies a node reference and a reference to the FreeMarker template. Alfresco will process the FreeMarker template in the context of the node specified and return the results. This is the closest you can get to the functionality of the Web Script Framework prior to 2.1.</p></li>
</ul>
<p>These options are all still available and may make sense depending on exactly what you are trying to do. But with 2.1 there's a potentially better way for interacting with the repository—the Web Script Framework.</p>
<p>The Web Script Framework essentially improves on the basic idea that started with URL addressability. Think of a web script as a chunk of code that is mapped to a human-readable (and search-engine readable) URL. So, for example, a URL that returns expense reports pending approval might look like:</p>
<pre><code>/alfresco/service/expenses/pending</code></pre>
<p>while a URL that returns expenses pending approval for a specific user might look like:</p>
<pre><code>/alfresco/service/expenses/pending/jpotts</code></pre>
<p>In the URL above, you could read the “jpotts” component of the URL as an implied argument. A more explicit way to provide an argument would be like:</p>
<pre><code>/alfresco/service/expenses/pending?user=jpotts</code></pre>
<p>Or maybe “pending” is an argument as well which tells the web script what status of expense reports to return. The point is that the structure of the URL and how (and if) your URL includes arguments is completely up to you.</p>
<p>The response the URL returns is also up to you. Your response might return HTML, XML, JSON, or even a JSR-168 Portlet.</p>
<p>The Web Script Framework makes it easy to follow the Model-View-Controller (MVC) pattern, although it isn't required. The Controller is server-side JavaScript, a Java Bean, or both. The Controller handles the request, performs any business logic that is needed, populates the Model with data, and then forwards the request to the View. The View is a FreeMarker template responsible for constructing a response in the appropriate format. The Model is essentially a data structure passed between the Controller and the View.</p>
<p>The mapping of URL to controller is done through an XML descriptor which is responsible for declaring the URL pattern, whether the script requires a transaction or not, and the authentication requirements for the script. The descriptor optionally describes arguments that can be passed to the script as well as the response formats that are available.</p>
<p>The response formats are mapped to FreeMarker templates through naming convention. So, for example, the FreeMarker template that returns expenses as HTML would be named with an extension of “html” while the one that returns XML would be named with an extension of “xml”.</p>
<p>The descriptor, the JavaScript file, and the FreeMarker templates can reside either in the repository or on the file system. If a Web Script uses a Java Bean, the class must reside somewhere on the classpath.</p>
<p>With these building blocks in mind you may already be thinking of different ways you could leverage Web Scripts. If not, let me help. You can use Web Scripts to expose the Alfresco content repository through a RESTful API to:</p>
<ul>
<li>Enable a front-end web application written in any language that can talk HTTP to retrieve repository data in XML, JSON, or any other format or to persist data to the repository;</li>
<li>Populate JSR-168 portlets;</li>
<li>Capture user-contributed content/data;</li>
<li>Interact with a business process (e.g., a JBPM workflow) through non-web client interfaces such as email;</li>
<li>Create ATOM or RSS feeds for repository content or business process data; and</li>
<li>Decompose the existing web client into smaller components which could potentially lend itself to being re-born in new and exciting ways!</li>
</ul>
<p>Okay, <em>you</em> probably shouldn't tackle that last one but rest assured that Alfresco is already working on it.</p>
<p>The last thing to mention is that Web Scripts are executed in a “Web Script Runtime”. In 2.1, there are three runtimes available out-of-the-box. The servlet runtime executes all web scripts requested via HTTP. The JSF runtime that allows JSF components to execute scripts. A JSR-168 runtime allows portlets to invoke web scripts directly.</p>
<p>You can write your own runtime if these don't meet your needs. Alfresco may add more in the future. At some point, you could see web script execution separated entirely from the Alfresco web application into its own process which would lend itself to load-balancing, scalability, etc.</p>
<p>In this article, we'll focus on the servlet runtime for HTTP.</p>
<p><strong>Web Scripts Directory</strong></p>
<p>The web client comes with a tool for listing and reloading web script definitions. To get to the tool, go to <a href="http://localhost:8080/alfresco/service/index">http://localhost:8080/alfresco/service/index</a>. You'll see links that let you browse the list of deployed web scripts and a button labeled “Refresh list of Web Scripts”. Although making changes to web scripts that reside in the repository does not require a restart, you may have to refresh the index with this button after a change.</p>
<p>Click through the links to see what is available out of the box. You'll notice that the tool itself is built using web scripts.</p>
<h1 id="examples"><a href="#examples">Examples</a></h1>
<p>Let's walk through some examples. We're going to start with a very simple Hello World web script. After that, we'll get progressively more complex until, at the end, we have a REST-based interface for creating, reading, and deleting SomeCo whitepaper ratings.</p>
<h2 id="hello-world-example"><a href="#hello-world-example">Hello World Example</a></h2>
<p>Let's implement the most basic web script possible: A Hello World script that echoes back an argument. We'll need one descriptor and one FreeMarker template. Do the following:</p>
<ol style="list-style-type: decimal">
<li>Log in to Alfresco.</li>
<li>Navigate to /Company Home/Data Dictionary/Web Scripts Extensions.</li>
<li><p>Create a file called helloworld.get.desc.xml with the following content:</p>
<pre><code>&lt;webscript&gt;
&lt;shortname&gt;Hello World&lt;/shortname&gt;
&lt;description&gt;Hello world web script&lt;/description&gt;
&lt;url&gt;/helloworld?name={nameArgument}&lt;/url&gt;
&lt;/webscript&gt;</code></pre></li>
<li><p>Create a file called helloworld.get.html.ftl with the following content:</p>
<pre><code>&lt;html&gt;
&lt;body&gt;
&lt;p&gt;Hello, ${args.name}!&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre></li>
<li>Go to <a href="http://localhost:8080/alfresco/service/index">http://localhost:8080/alfresco/service/index</a> and press the Refresh button. If you then click the “List Web Scripts” link you should be able to find the web script you just defined.</li>
<li><p>Now go to <a href="http://localhost:8080/alfresco/service/helloworld?name=Jeff">http://localhost:8080/alfresco/service/helloworld?name=Jeff</a>. You should see:</p>
<pre><code>Hello, Jeff!</code></pre></li>
</ol>
<p>A few things to note. First, notice the file names include “get”. That's the HTTP method used to call the URL. In later examples we'll see how to use POST and DELETE. By differentiating on the HTTP method, you can have multiple controllers for the same “service” depending on how the service is called (GET vs. POST, etc.). Second, in this case we only had one argument but we could add as many as we need. Watch out, though! Descriptors must be valid XML which means ampersands must be escaped. So the proper way to define a URL with multiple arguments is:</p>
<pre><code>&lt;url&gt;/helloworld?name={nameArgument}&amp;amp;secondArg={anotherArg}&lt;/url&gt;</code></pre>
<p>Third, notice we didn't include a JavaScript file in this example but the script still ran because controllers are optional.</p>
<p>Most scripts are going to use a controller, though, so let's go ahead and add one.</p>
<ol style="list-style-type: decimal">
<li><p>Create a file called helloworld.get.js with the following content:</p>
<pre><code>model.foo = &quot;bar&quot;;</code></pre></li>
<li><p>Update your helloworld.get.html.ftl file with the following content:</p>
<pre><code>&lt;html&gt;
&lt;body&gt;
&lt;p&gt;Hello, ${args.name}!&lt;/p&gt;
&lt;p&gt;Foo: ${foo}&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre></li>
<li>Go to <a href="http://localhost:8080/alfresco/service/index">http://localhost:8080/alfresco/service/index</a> and press the Refresh button. This is required because you added a controller that the web script run-time didn't know about.</li>
<li><p>Now go to your web browser and enter the same URL from the first example which was <a href="http://localhost:8080/alfresco/service/helloworld?name=Jeff">http://localhost:8080/alfresco/service/helloworld?name=Jeff</a>. You should see:</p>
<pre><code>Hello, Jeff!

Foo: bar</code></pre></li>
</ol>
<p>What's going on here is that the controller is getting executed before the FreeMarker template. In the controller we can do anything the Alfresco JavaScript API can do. In this case, we didn't leverage the JavaScript API at all—we just put some data into the “model” object which was then read by the FreeMarker template. In subsequent examples the controller will have more work to do and in one case, we'll use Java instead of JavaScript for the controller.</p>
<h1 id="someco-whitepaper-user-contributed-ratings-examples"><a href="#someco-whitepaper-user-contributed-ratings-examples">SomeCo Whitepaper User-contributed Ratings Examples</a></h1>
<p>We want to create a REST API that front-end developers can use to find whitepapers and ratings as well as post new ratings. Before we dive in, it probably makes sense to rough out the API.</p>
<table>
<caption>Planned ratings API</caption>
<thead>
<tr class="header">
<th align="left">URL</th>
<th align="left">Method</th>
<th align="left">Description</th>
<th align="left">Response Formats</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">/someco/whitepapers</td>
<td align="left">GET</td>
<td align="left">Returns a list of whitepapers.</td>
<td align="left">HTML, JSON</td>
</tr>
<tr class="even">
<td align="left">/someco/rating?id={id}</td>
<td align="left">GET</td>
<td align="left">Gets the average rating for a given whitepaper by passing in the whitepaper's noderef.</td>
<td align="left">HTML, JSON</td>
</tr>
<tr class="odd">
<td align="left">/someco/rating?id={id}&amp;rating={rating}&amp;user={user}</td>
<td align="left">POST</td>
<td align="left">Creates a new rating for the specified whitepaper by passing in a rating value and the user who posted the rating.</td>
<td align="left">HTML, JSON</td>
</tr>
<tr class="even">
<td align="left">/someco/rating?id={id}</td>
<td align="left">DELETE</td>
<td align="left">Deletes all ratings for a specified whitepaper.</td>
<td align="left">HTML</td>
</tr>
</tbody>
</table>
<div class="figure">
<img src="images/whitepaper-index.png" alt="The index of whitepapers uses an AJAX call to retrieve whitepaper metadata and ratings" /><p class="caption">The index of whitepapers uses an AJAX call to retrieve whitepaper metadata and ratings</p>
</div>
<p>When this API is in place, front-end developers can incorporate whitepapers and user-contributed ratings into the SomeCo web site. The following screenshots show pages that use the API we're going to build to query for whitepaper and ratings data. It looks like the folks at SomeCo have shamelessly ripped off the Optaros publications section. They didn't even bother to change the logo.</p>
<div class="figure">
<img src="images/whitepaper-detail.png" alt="The detail page also uses an AJAX call and includes the same ratings widget as well as a download link" /><p class="caption">The detail page also uses an AJAX call and includes the same ratings widget as well as a download link</p>
</div>
<p>You can't tell from the screenshots, but the ratings widget is clickable. When clicked it sends an asynchronous post to the /someco/rating URL described in the table above. When the “Get the White Paper” link is clicked, the page in Illustration 2 is displayed. I reused the description from the index page for the Executive Summary. In the real world this would probably be a more lengthy description separate from the introduction on the index page. The “Download this white paper” link uses the standard “Download URL” to give the user direct access to the content.</p>
<h2 id="listing-all-whitepapers"><a href="#listing-all-whitepapers">Listing all Whitepapers</a></h2>
<p>As a quick review, recall that SomeCo writes whitepapers and manages those papers with Alfresco. Some whitepapers are published to the web site. A custom aspect called “webable” has a flag called isActive. Whitepapers with the isActive flag set to true should be shown on the web site. For this article, we're going to ignore the webable aspect and the isActive flag. We'll just assume any sub-type of sc:whitepaper found in the /Someco/Whitepapers folder is fair game. (If this bugs you, see the sidebar).</p>
<p>Let's write a web script that returns all whitepapers. We want the list in two formats HTML and JSON. HTML will allow us to easily test the service and JSON will make it easy for code on the front-end to process the list. This will require four files: one descriptor, one JavaScript controller, and two FreeMarker templates—one for each format.</p>
<h3 id="sidebar-enabling-a-subset-of-whitepapers-for-web-display"><a href="#sidebar-enabling-a-subset-of-whitepapers-for-web-display">Sidebar: Enabling a subset of whitepapers for web display</a></h3>
<p>The real-world solution this example is based on uses UI actions to enable and disable the “sc:isActive” flag. An Evaluator class hides or shows the “Enable Web” or “Disable Web” UI action link based on the value of the flag and the group membership of the user. If you want to do something similar on your own, the sc:webable aspect is in the model included with the source code for this article. And, I've included two scripts (enableWeb.js and disableWeb.js) that you can use to attach the webable aspect and set the isActive flag appropriately. If you want the whitepaper service to filter the list based on the isActive flag, the Lucene query in the whitepaper.get.js file needs to be appended with “<span class="citation">@sc</span>\\:isActive:true” to show only active whitepapers. I left this functionality out of the example because it isn't core to the topic.</p>
<h3 id="organizing-your-code"><a href="#organizing-your-code">Organizing your code</a></h3>
<p>Before we start coding, let's talk a bit about organization. First, packages. The Web Script Framework allows us to organize script assets into a hierarchical folder or package structure. Just as it is with Java it is probably a good idea to do this for all web scripts. Following a reverse domain name pattern is probably a good convention. So we'll be using “com/someco” for our package which means our files will reside under /Company Home/Data Dictionary/Web Scripts Extensions/com/someco.[^1^](#sdfootnote1sym)</p>
<p>Next, URLs can follow any pattern we want, but they will always start with &lt;alfresco webapp&gt;/service where “&lt;alfresco webapp&gt;” is the name of the Alfresco web application context (usually “alfresco”). Because the URL pattern must be unique, it is probably a good idea to incorporate the package name in the URL. In this article we'll prefix all URLs with “someco”.</p>
<p>Alfresco reserves certain package names and URLs for their own use (see the Alfresco wiki) but by following the conventions proposed here, you'll steer clear of those.</p>
<p>Finally, you've seen that web script assets can reside in the repository, but they can also reside in the file system. The only requirement is that they be on the classpath, but I suggest that they reside in the “alfresco/extension” directory just like your other extensions. Following the package structure suggested earlier, if we were to store our scripts on the file system, rather than the repository, we'd put them in alfresco/extension/templates/webscripts/com/ someco.</p>
<p>The advantage of using the file system is that the web scripts that make up your solution can be deployed alongside your other extensions without requiring anyone to upload them to the repository. The disadvantage is that changes require a restart.</p>
<p>In the source code I've provided with this article, the web scripts are set up to deploy to the file system with the other extensions. If, instead of deploying the sample code, you want to follow along and you want to avoid restarts, move my scripts out of the alfresco extension directory before you deploy, then upload your scripts to the repository like we did for the Hello World example.</p>
<p>If scripts are defined in the repository as well as the classpath, the files in the repository take precedence over the files on the classpath. The Alfresco wiki documents the search order for web scripts (See “Where to find more information” at the end of this article for a list of references).</p>
<h3 id="step-1-the-descriptor"><a href="#step-1-the-descriptor">Step 1: The descriptor</a></h3>
<p>With that, we should be good to go. The first step is to create the descriptor file. It should be named whitepapers.get.desc.xml and should look like this:</p>
<pre><code>&lt;webscript&gt;
    &lt;shortname&gt;Get all whitepapers&lt;/shortname&gt;
    &lt;description&gt;Returns a list of active whitepapers&lt;/description&gt;
    &lt;url&gt;/someco/whitepapers&lt;/url&gt;
    &lt;url&gt;/someco/whitepapers.json&lt;/url&gt;
    &lt;url&gt;/someco/whitepapers.html&lt;/url&gt;
    &lt;format default=&quot;json&quot;&gt;extension&lt;/format&gt;
    &lt;authentication&gt;guest&lt;/authentication&gt;
    &lt;transaction&gt;none&lt;/transaction&gt;
&lt;/webscript&gt;</code></pre>
<p>There are a few elements in this descriptor we didn't see in the Hello World example. First, notice that there are multiple URL elements. There is one URL for each format plus a URL without a format. This shows how to request a different output format from the same base URL. Because the URLs differ only in format, it isn't strictly required that they be listed in the descriptor, but it is a good practice.</p>
<p>In this case, we're using the “extension” syntax—the extension on the URL specifies the format. An alternative syntax is to use the “argument” syntax like this:</p>
<pre><code>&lt;url&gt;/someco/whitepapers?format=json&lt;/url&gt;

&lt;url&gt;/someco/whitepapers?format=html&lt;/url&gt;</code></pre>
<p>My current thinking is that the extension syntax is preferred because it is friendlier to search engines but there may be reasons to use the argument syntax.</p>
<p>The format element declares the type of syntax we're using and defines a default output format. If you want to accept either syntax, you can use “any” as the format. In our case, using this descriptor if someone uses the argument syntax, they'll get an Error 500. If someone uses the URL without specifying a format, they'll get JSON.</p>
<p>The authentication element declares the lowest level of authentication required for this script. If your script touches the repository you will want this to be Guest or higher. Other options are “none”, “user”, and “admin”.</p>
<p>The transaction element specifies the level of transaction required by the script. Listing whitepapers doesn't need a transaction so we've got it set to “none”. Other possible values are “required” and “requiresnew”.</p>
<h3 id="step-2-the-controller"><a href="#step-2-the-controller">Step 2: The Controller</a></h3>
<p>Next, we need a controller. Create a file called whitepapers.get.js with the following content:</p>
<pre><code>&lt;import resource=&quot;classpath:alfresco/extension/scripts/rating.js&quot;&gt;

var whitepapers = search.luceneSearch(&quot;PATH:\\&quot;/{http://www.alfresco.org/model/application/1.0}company\_home/{http://www.alfresco.org/model/content/1.0}Someco\\&quot; +TYPE:\\&quot;{[http://www.someco.com/model/content/1.0](http://www.someco.com/model/content/1.0)}whitepaper\\&quot;&quot;);

if (whitepapers == null || whitepapers.length == 0) {

    logger.log(&quot;No whitepapers found&quot;);
    status.code = 404;
    status.message = &quot;No whitepapers found&quot;;
    status.redirect = true;
    
} else {

    var whitepaperInfo = new Array();
    
    for (i = 0; i \&lt; whitepapers.length; i++) {
    
    var whitepaper = new whitepaperEntry(whitepapers[i],
    getRating(whitepapers[i]));
    
    whitepaperInfo[i] = whitepaper;

}

model.whitepapers = whitepaperInfo;

}

function whitepaperEntry(whitepaper, rating) {
    this.whitepaper = whitepaper;
    this.rating = rating;
}</code></pre>
<p>The first thing to notice about the script is that we're importing another script. The rating.js script was created as part of the last article to contain logic used to calculate the average rating. The idea here is that retrieving a rating is also business logic related to a rating, so it should reside in the rating.js file as well. This makes it easy for us to reuse that logic in other scripts. We'll see the updated version of the rating.js script momentarily. (The ability to import a script from another script was added with release 2.1. The import tag is not native to the Rhino JavaScript implementation).</p>
<p>The next thing to notice is that the script queries the repository using Lucene to get a list of whitepapers. Look at what happens if there are no whitepapers found. The response code gets set to 404 which is the standard HTTP response code for “File not found”. Alfresco has a standard response template for error codes but you can override it with your own by creating FreeMarker templates that follow a specific naming convention. For example, we could have a custom 404 response template for whitepapers by creating a file called whitepapers.get.html.404.ftl. See the Alfresco wiki for more information.</p>
<p>The last thing that happens is that we build a new Array for our results. I could just set model.whitepapers equal to the whitepapers variable that contains the query results but I want to add some data to the result set, so I'm building a new Array and setting that to the model. (I know the average rating is a property of a whitepaper, so it may not yet be obvious why I have a separate function for retrieving the rating or why I would store the rating in the model separate from the whitepaper. Trust that it will make sense later).</p>
<p>Remember that our controller imports a script called rating.js. This script resides in our classpath but the import tag also supports including scripts that reside in the repository. If you still have rating.js around from the custom behaviors article, the difference between it and this one is a new function called getRating as shown below:</p>
<pre><code>function getRating(curNode) {
    var rating = {};
    rating.average = curNode.properties[&quot;{http://www.someco.com/model/content/1.0}averageRating&quot;];
    rating.count = curNode.properties[&quot;{http://www.someco.com/model/content/1.0}ratingCount&quot;];
    return rating;
}</code></pre>
<p>The function simply retrieves the averageRating and ratingCount properties from the specified node and returns them in a rating object. The full source for rating.js is in the accompanying source code.</p>
<h3 id="step-3-the-view"><a href="#step-3-the-view">Step 3: The view</a></h3>
<p>Assuming there are items in the search results, we'll need FreeMarker templates to process them. Let's create the HTML response template first. Create a new file called whitepapers.get.html.ftl with the following content:</p>
<pre><code>&lt;#assign datetimeformat=&quot;EEE, dd MMM yyyy HH:mm:ss zzz&quot;&gt;
&lt;html&gt;
    &lt;body&gt;
        &lt;h3&gt;Whitepapers&lt;/h3&gt;
        &lt;table&gt;
            &lt;#list whitepapers as child&gt;
                &lt;tr&gt;
                    &lt;td&gt;&lt;b&gt;Name&lt;/b&gt;&lt;/td&gt;
        &lt;td&gt;${child.whitepaper.properties.name}&lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                    &lt;td&gt;&lt;b&gt;Title&lt;/b&gt;&lt;/td&gt;
        &lt;td&gt;${child.whitepaper.properties[&quot;cm:title&quot;]}&lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                    &lt;td&gt;&lt;b&gt;Link&lt;/b&gt;&lt;/td&gt;
        &lt;td&gt;&lt;a href=&quot;${url.context}${child.whitepaper.url}?guest=true&quot;&gt;${url.context}${child.whitepaper.url}&lt;/a&gt;&lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                    &lt;td&gt;&lt;b&gt;Type&lt;/b&gt;&lt;/td&gt;
        &lt;td&gt;${child.whitepaper.mimetype}&lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                    &lt;td&gt;&lt;b&gt;Size&lt;/b&gt;&lt;/td&gt;
        &lt;td&gt;${child.whitepaper.size}&lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                    &lt;td&gt;&lt;b&gt;Id&lt;/b&gt;&lt;/td&gt;
        &lt;td&gt;${child.whitepaper.id}&lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                    &lt;td&gt;&lt;b&gt;Description&lt;/b&gt;&lt;/td&gt;
                    &lt;td&gt;&lt;p&gt;&lt;#if child.whitepaper.properties[&quot;cm:description&quot;]?exists
                &amp;&amp; child.whitepaper.properties[&quot;cm:description&quot;] !=
                &quot;&quot;&gt;${child.whitepaper.properties[&quot;cm:description&quot;]}&lt;/#if&gt;&lt;/p&gt;
                    &lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                    &lt;td&gt;&lt;b&gt;Pub Date&lt;/b&gt;&lt;/td&gt;
        &lt;td&gt;${child.whitepaper.properties[&quot;cm:modified&quot;]?string(datetimeformat)}&lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                    &lt;td&gt;&lt;b&gt;&lt;a href=&quot;${url.serviceContext}/rating.html?id=${child.whitepaper.id}&amp;guest=true&quot;&gt;Rating&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;
                    &lt;td&gt;
                        &lt;table&gt;
                            &lt;tr&gt;
                                &lt;td&gt;&lt;b&gt;Average&lt;/b&gt;&lt;/td&gt;
                &lt;td&gt;${child.rating.average}&lt;/td&gt;
                            &lt;/tr&gt;
                            &lt;tr&gt;
                                &lt;td&gt;&lt;b&gt;Count&lt;/b&gt;&lt;/td&gt;
                &lt;td&gt;${child.rating.count}&lt;/td&gt;
                            &lt;/tr&gt;
                        &lt;/table&gt;
                    &lt;/td&gt;
                &lt;/tr&gt;
                &lt;#if !(child.whitepaper == whitepapers?last.whitepaper)&gt;
                    &lt;tr&gt;
            &lt;td colspan=&quot;2&quot; bgcolor=&quot;999999&quot;&gt;&amp;nbsp;&lt;/td&gt;
        &lt;/tr&gt;
                &lt;/#if&gt;
            &lt;/#list&gt;
        &lt;/table&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>This template iterates through the query results passed in by the controller, and builds an HTML table with properties of each whitepaper. (Yes, the table is ugly. Yes, you could use CSS to spruce it up tremendously or even remove the table entirely. But for SomeCo, this response template is really for debugging purposes only and I didn't want to fool with the CSS so a table it is).</p>
<p>The last thing we have to do before we test the web script is create the JSON response template. Create a file called whitepapers.get.json.ftl with the following content:</p>
<pre><code>&lt;#assign datetimeformat=&quot;EEE, dd MMM yyyy HH:mm:ss zzz&quot;&gt;
{&quot;whitepapers&quot; : [
    &lt;#list whitepapers as child&gt;
        {
            &quot;name&quot; : &quot;${child.whitepaper.properties.name}&quot;,
            &quot;title&quot; : &quot;${child.whitepaper.properties[&quot;cm:title&quot;]}&quot;,
            &quot;link&quot; : &quot;${url.context}${child.whitepaper.url}&quot;,
            &quot;type&quot; : &quot;${child.whitepaper.mimetype}&quot;,
            &quot;size&quot; : &quot;${child.whitepaper.size}&quot;,
            &quot;id&quot; : &quot;${child.whitepaper.id}&quot;,
            &quot;description&quot; : &quot;&lt;#if child.whitepaper.properties[&quot;cm:description&quot;]?exists &amp;&amp; child.whitepaper.properties[&quot;cm:description&quot;] != &quot;&quot;&gt;${child.whitepaper.properties[&quot;cm:description&quot;]}&lt;/#if&gt;&quot;,
            &quot;pubDate&quot; : &quot;${child.whitepaper.properties[&quot;cm:modified&quot;]?string(datetimeformat)}&quot;,
            &quot;rating&quot; : {
                &quot;average&quot; : &quot;${child.rating.average}&quot;,
                &quot;count&quot; : &quot;${child.rating.count}&quot;,
            }
        }
        &lt;#if !(child.whitepaper == whitepapers?last.whitepaper)&gt;,&lt;/#if&gt;
    &lt;/#list&gt;
    ]
}</code></pre>
<p>Again, just like the HTML response template, the script iterates through the result set but this one outputs JSON. The JSON structure is completely arbitrary.</p>
<p>Assuming you have some test data in your repository (Someco Whitepaper objects in your Someco/Whitepapers folder) you should be able to refresh the web script list and run the web script. Because we told Alfresco that this script requires Guest access or higher, you'll need to either log in to Alfresco before running the script, authenticate with a valid user and password when the basic authentication dialog is presented, or append “&amp;guest=true” to the URL like this: <a href="http://localhost:8080/alfresco/service/someco/whitepapers.html&amp;guest=true">http://localhost:8080/alfresco/service/someco/whitepapers.html&amp;guest=true</a>. If you forget the “.html” you'll get a JSON response because we set that to the default.</p>
<p>If all goes well you should see something similar to the figure below:</p>
<div class="figure">
<img src="images/whitepapers.png" alt="The whitepapers list output by the web script" /><p class="caption">The whitepapers list output by the web script</p>
</div>
<h3 id="debugging"><a href="#debugging">Debugging</a></h3>
<p>Did it work? If not, it's time to debug. The first thing you're going to want to do is to go into log4j.properties and set log4j.logger.org.alfresco.repo.jscript to DEBUG. This will cause any logger.log statements in your controller to write to catalina.out.</p>
<p>Another tool you'll want to leverage is the web script list. You can use it to see (1) if Alfresco knows about your script and (2) the version of the scripts the run-time knows about. For example, you can go to <a href="http://localhost:8080/alfresco/service/script/com/someco/whitepapers/whitepapers.get">http://localhost:8080/alfresco/service/script/com/someco/whitepapers/whitepapers.get</a> and Alfresco will dump the descriptor and all of the response templates.</p>
<p>The Node Browser can be helpful to debug problems as well. In this case, for example, we're running a Lucene query in our JavaScript. If the controller isn't finding any whitepapers even though you've created test data, try executing the query in the Node Browser. If it doesn't return results, there's something wrong with your test data.</p>
<h2 id="retrieving-the-rating-for-a-whitepaper"><a href="#retrieving-the-rating-for-a-whitepaper">Retrieving the Rating for a Whitepaper</a></h2>
<p>Getting a specific rating is roughly the same as getting a whitepaper but it is a bit easier because of our existing getRating function in rating.js. All the controller has to do is grab the ID argument, locate the node, then call getRating as shown below:</p>
<pre><code>&lt;import resource=&quot;classpath:alfresco/extension/scripts/rating.js&quot;\&gt;
if (args.id == null || args.id.length == 0) {
    logger.log(&quot;ID arg not set&quot;);
    status.code = 400;
    status.message = &quot;Node ID has not been provided&quot;;
    status.redirect = true;
} else {
    logger.log(&quot;Getting current node&quot;);
    var curNode = search.findNode(&quot;workspace://SpacesStore/&quot; + args.id);
    if (curNode == null) {
        logger.log(&quot;Node not found&quot;);
        status.code = 404;
        status.message = &quot;No node found for id:&quot; + args.id;
        status.redirect = true;
    } else {
        model.rating = getRating(curNode, args.user);
    }
}</code></pre>
<p>The descriptor and response templates are very similar to the whitepaper example so I won't include them here. After we get the post in place, we'll revisit the HTML response template by making some updates that help us test.</p>
<p>For now, here's what a successful JSON call to the rating service returns:</p>
<pre><code>{&quot;rating&quot; :
    {
        &quot;average&quot; : &quot;1.923&quot;,
        &quot;count&quot; : &quot;13&quot;,
    }
}</code></pre>
<h2 id="posting-a-rating-with-a-java-backed-web-script"><a href="#posting-a-rating-with-a-java-backed-web-script">Posting a Rating with a Java-backed Web Script</a></h2>
<p>Before we talk about the POST web script we should talk about authentication. All of our /someco scripts require Guest access or higher. That means we either have to have an active session already established, we have to append “&amp;guest=true” to the URL, or we have to login when the browser presents us with a basic authentication dialog. (Another option is to get a ticket from a web service call, but that's not in the scope of this article).</p>
<p>SomeCo doesn't want to open up write access to the /Someco/Whitepapers folder to Guest users who might try to access the repository via the web client so that means we need a real user account in order to write new rating objects. We could use “user” authentication for the POST but SomeCo doesn't want to set up user accounts for every user that might rate content.</p>
<p>The solution is to let Guest call the POST URL but leverage the Alfresco Java API to “run as” a different user. (In our case we'll use admin but a user account dedicated to the purpose of creating ratings is probably a better idea). The post logic will reside in a Java Bean rather than a server-side JavaScript file.</p>
<p>The descriptor and the response templates look like the examples we've seen so far so I won't repeat them here. Take a look at the accompanying source code if you are curious.</p>
<p>The piece that is new is the use of Java as the controller so let's spend some time on that. We'll implement this Java-backed web script in three steps. The first step is to write the business logic for creating the rating. Just like when we put the business logic in the rating.js file to promote reuse, we're going to use the Rating bean we created in the previous article for the new create() method. The second step is to write the Java bean that functions as our controller. The third step is to configure the controller bean via Spring so that Alfresco knows to invoke it when the web script is called.</p>
<h3 id="step-1-business-logic"><a href="#step-1-business-logic">Step 1: Business logic</a></h3>
<p>Add the following method to the com.someco.behavior.Rating class we created in the previous article.</p>
<pre><code>public void create(NodeRef nodeRef, int rating, String user) {
    boolean switchUser = false;
    String currentUser = AuthenticationUtil.getCurrentUserName();
    if (!currentUser.equals(&quot;admin&quot;)) {
        logger.debug(&quot;Current user is not admin so switching to admin&quot;);
        AuthenticationUtil.setCurrentUser(&quot;admin&quot;);
        switchUser = true;
    }

    UserTransaction txn = transactionService.getUserTransaction();
    
    try {
        txn.begin();

        // add the aspect to this document if it needs it
        if (nodeService.hasAspect(nodeRef,
            Qname.createQName(SomeCoModel.NAMESPACE_SOMECO_CONTENT_MODEL,
            SomeCoModel.ASPECT_SC_RATEABLE))) {
            logger.debug(&quot;Document already has aspect&quot;);
        } else {
            logger.debug(&quot;Adding rateable aspect&quot;);
            nodeService.addAspect(nodeRef,
            Qname.createQName(SomeCoModel.NAMESPACE_SOMECO_CONTENT_MODEL,
            SomeCoModel.ASPECT_SC_RATEABLE), null);
        }
        
        Map&lt;QName, Serializable&gt; props = new HashMap&lt;QName,
        Serializable&gt;();
        
        props.put(QName.createQName(SomeCoModel.NAMESPACE_SOMECO_CONTENT_MODEL,
        &quot;rating&quot;), rating);
        props.put(QName.createQName(SomeCoModel.NAMESPACE_SOMECO_CONTENT_MODEL,
        &quot;rater&quot;), user);
        
        nodeService.createNode(nodeRef,
        Qname.createQName(SomeCoModel.NAMESPACE_SOMECO_CONTENT_MODEL,
        SomeCoModel.ASSN_SC_RATINGS),
        Qname.createQName(SomeCoModel.NAMESPACE_SOMECO_CONTENT_MODEL,
        &quot;rating&quot; + new Date().getTime()),
        Qname.createQName(SomeCoModel.NAMESPACE_SOMECO_CONTENT_MODEL,
        SomeCoModel.TYPE_SC_RATING), props);
        txn.commit();
    } catch(Throwable e) {
        try {
            if (txn.getStatus() == Status.STATUS_ACTIVE) txn.rollback();
        } catch (Throwable ee) {
            e.printStackTrace();
        }
    }
    
    if (switchUser) AuthenticationUtil.setCurrentUser(currentUser);
}</code></pre>
<p>This is a bit painful to look at but basically what's going on is:</p>
<ul>
<li>If the current user is not admin, the current user is set to admin</li>
<li>A new transaction is started</li>
<li>If the node doesn't yet have the rateable aspect, it is added</li>
<li>The rating and rater properties are set</li>
<li>The transaction is committed</li>
<li>If the current user was switched to admin, the current user is switched back to whomever it was before the switch to admin</li>
</ul>
<h3 id="step-2-web-script-controller-bean"><a href="#step-2-web-script-controller-bean">Step 2: Web script controller bean</a></h3>
<p>With the create() method in place, all we have to do is write a Java class that grabs the id, rating, and rater arguments and calls the method. To do that, create a new class called com.someco.scripts.PostRating. The class name isn't significant but it seems like following some sort of descriptive convention could be helpful here if there are a large number of Java-backed scripts. The class needs to extend org.alfresco.webscripts.DeclarativeWebScript. Our logic goes in executeImpl as shown below.</p>
<pre><code>public class PostRating extends
org.alfresco.web.scripts.DeclarativeWebScript {
    Logger logger = Logger.getLogger(PostRating.class);
    
    private Rating ratingBean;
    
    @Override
    protected Map&lt;String, Object&gt; executeImpl(WebScriptRequest req,
    WebScriptStatus status) {
    
        String id = req.getParameter(&quot;id&quot;);
        String rating = req.getParameter(&quot;rating&quot;);
        String user = req.getParameter(&quot;user&quot;);
        
        if (id == null || rating == null || rating.equals(&quot;0&quot;) ||
        user == null) {
            logger.debug(&quot;ID, rating, or user not set&quot;);
            status.jsSet_code(400);
            status.jsSet_message(&quot;Required data has not been provided&quot;);
            status.jsSet_redirect(true);
        } else {
            NodeRef curNode = new NodeRef(&quot;workspace://SpacesStore/&quot; + id);
            if (curNode == null) {
                logger.debug(&quot;Node not found&quot;);
                status.jsSet_code(404);
                status.jsSet_message(&quot;No node found for id:&quot; + id);
                status.jsSet_redirect(true);
            } else {
                ratingBean.create(curNode, Integer.parseInt(rating), user);
            }
        }
        
        Map&lt;String, Object&gt; model = new HashMap&lt;String, Object&gt;();
        model.put(&quot;node&quot;, id);
        model.put(&quot;rating&quot;, rating);
        model.put(&quot;user&quot;, user);

        return model;
        
    }
    
    public Rating getRatingBean() {
        return ratingBean;
    }
    
    public void setRatingBean(Rating ratingBean) {
        this.ratingBean = ratingBean;
    }
    
}</code></pre>
<p>This code should look strikingly similar to a JavaScript controller and in fact it does the same thing. It checks the arguments, sets an error code if the arguments are missing, and then writes some data to the model.</p>
<p>The controller gets the Rating class through Spring dependency injection. We'll configure that in our Spring config, which is the next step.</p>
<h3 id="step-3-spring-config-for-the-web-script-controller-bean"><a href="#step-3-spring-config-for-the-web-script-controller-bean">Step 3: Spring config for the Web script controller bean</a></h3>
<p>The following shows the contents of someco-scripts-context.xml. The name of the file isn't important, but it must end with *context.xml.</p>
<pre><code>&lt;?xml version=&#39;1.0&#39; encoding=&#39;UTF-8&#39;?&gt;
&lt;!DOCTYPE beans PUBLIC &#39;-//SPRING//DTD BEAN//EN&#39; &#39;http://www.springframework.org/dtd/spring-beans.dtd&#39;&gt;
&lt;beans&gt;
    &lt;bean id=&quot;webscript.com.someco.ratings.rating.post&quot; class=&quot;com.someco.scripts.PostRating&quot; parent=&quot;webscript&quot;&gt;
        &lt;property name=&quot;ratingBean&quot;&gt;
            &lt;ref bean=&quot;ratingBehavior&quot; /&gt;
        &lt;/property&gt;
    &lt;/bean&gt;
&lt;/beans&gt;</code></pre>
<p>This should look like any other Spring bean config file you've seen. The web script magic is in the id and parent attributes. The id follows a naming convention. The convention is:</p>
<pre><code>webscript.package.service-id.method</code></pre>
<p>Pay close attention to the use of the singular “webscript” here versus the plural “webscripts” in the Data Dictionary folders. That's a potential multi-hour debugging session ending in a forehead slap with a “Doh!” if you aren't careful.</p>
<p>It is probably worth mentioning that a decision to use a Java-backed web script doesn't exclude the use of JavaScript for that web script. If you have both a Java class and a JavaScript file, the Java class gets executed first followed by the JavaScript. The script has access to everything the Java class put in the model and can update the model before passing it along to the response template.</p>
<h2 id="revisiting-the-rating.get.html.ftl-template"><a href="#revisiting-the-rating.get.html.ftl-template">Revisiting the rating.get.html.ftl template</a></h2>
<p>Now we have everything we need in place but we don't have a great way to test the rating POST. So, what we'll do is add a little rating widget[^0^](#sdfootnote2sym) to the rating.get.html.ftl template. A simple link would do but I wanted to test out the widget before incorporating it into a real page.</p>
<p>First, let's see what it looks like when we call /someco/rating.html/id=someid. The figure below shows a call when the whitepaper node has 13 ratings and an average of 1.923.</p>
<div class="figure">
<img src="images/rating-html.png" alt="Displaying the ratings data for a specific node" /><p class="caption">Displaying the ratings data for a specific node</p>
</div>
<p>The purpose of the rating widget is two-fold. First, it graphically displays the average rating for a whitepaper. Second, each star in the widget is hot. So when you click one of the rating stars, an asynchronous post is made to /someco/rating which causes a new rating object to get created. The rating posted depends on the star clicked. The person submitting the rating would normally be passed in based on some sort of credential, maybe from a portal session or a cookie. In our little test, the rater gets pulled from the field.</p>
<p>Let's look at HTML first, then some of the JavaScript:</p>
<pre><code>&lt;p&gt;&lt;a href=&quot;${url.serviceContext}/whitepapers.html?guest=true&quot;&gt;Back
to the list&lt;/a&gt; of whitepapers&lt;/p&gt;
&lt;p&gt;Node: ${args.id}&lt;/p&gt;
&lt;p&gt;Average: ${rating.average}&lt;/p&gt;
&lt;p&gt;# of Ratings: ${rating.count}&lt;/p&gt;
&lt;form name=&quot;login&quot;&gt;
    Rater:&lt;input name=&quot;userId&quot;&gt;&lt;/input&gt;
&lt;/form&gt;
Rating: &lt;div class=&quot;rating&quot; id=&quot;rating_${args.id}&quot; style=&quot;display:inline&quot;&gt;${rating.average}&lt;/div&gt;</code></pre>
<p>This is all basic HTML/FreeMarker stuff you've seen before. The last line sets up a div for the ratings widget. The id of the div uses the node ref of the whitepaper. This allows multiple ratings widgets to be on the same page and makes it easy for the JavaScript to pass the node ref on to the /someco/rating URL.</p>
<p>The second piece is the JavaScript. I'm going to omit some of the less interesting functions and just show the functions related to posting ratings. The accompanying source code has the full source.</p>
<pre><code>function submitRating(evt) {
    var tmp = Event.element(evt).getAttribute(&#39;id&#39;).substr(5);
    var widgetId = tmp.substr(0, tmp.indexOf(&#39;\_&#39;));
    var starNbr = tmp.substr(tmp.indexOf(&#39;\_&#39;)+1);
    alert(&quot;Post to URL:&quot; + widgetId + &quot;,&quot; + starNbr);
    if (document.login.userId.value != undefined &amp;&amp;
        document.login.userId.value != &quot;&quot;) {
        curUser = document.login.userId.value;
    } else {
        curUser = &quot;jpotts&quot;;
    }
    postRating(widgetId, starNbr, curUser);
}

function postRating(id, rating, user) {
    if (receiveReq.readyState == 4 || receiveReq.readyState == 0) {
        receiveReq.open(&quot;POST&quot;, &quot;/alfresco/service/someco/rating?id=&quot; + id +
        &quot;&amp;rating=&quot; + rating + &quot;&amp;guest=true&amp;user=&quot; + user, true);
        receiveReq.onreadystatechange = handleRatingPosted;
        receiveReq.send(null);
    }
}

function handleRatingPosted() {
    if (receiveReq.readyState == 4) {
        alert(&quot;Post successful&quot;);
    }
}</code></pre>
<p>Those of you familiar with AJAX techniques may be wondering why I didn't use Prototype to make the post since I was already using it with the rating widget. I had trouble getting Prototype to play nicely with the Web Script Framework. For some reason the arguments weren't getting recognized. So I punted and used the lower-level XMLHttpRequest. You'll also notice that I don't dynamically update the rating or re-init the widget after the successful post. My only excuse for that one is laziness.</p>
<h2 id="deleting-ratings"><a href="#deleting-ratings">Deleting ratings</a></h2>
<p>Setting up a web script for delete is similar to the GET for ratings. The descriptor is named rating.delete.desc.xml. I set mine to require “admin” authentication. It seems rare that you would want to delete all ratings for a given node but highly likely that if you are going to expose it, it should be for admins only.</p>
<p>As in previous examples, the controller JavaScript reads and checks the arguments then calls a function. In this case it is the deleteRatings function that has been added to rating.js. The body of the function is:</p>
<pre><code>function deleteRatings(curNode) {
    // check the parent to make sure it has the right aspect
    if (curNode.hasAspect(&quot;{http://www.someco.com/model/content/1.0}rateable&quot;)) {
        // continue, this is what we want
    } else {
        logger.log(&quot;Node did not have rateable aspect.&quot;);
        return;
    }

    // get the node&#39;s children
    var children = curNode.children;
    
    if (children != null &amp;&amp; children.length \&gt; 0) {
        logger.log(&quot;Found children...iterating&quot;);
        for (i in children) {
            var child = children[i];
            logger.log(&quot;Removing child: &quot; + child.id);
            child.remove();
        }
    }
}</code></pre>
<p>The script bails if the node doesn't have the rateable aspects (because there wouldn't be any ratings). Otherwise, it grabs the children and deletes them. Note the important assumption that the only children that exist are ratings. If there's a possibility of other child associations, you'd obviously want to be more discriminating.</p>
<h2 id="example-summary"><a href="#example-summary">Example summary</a></h2>
<p>We've implemented two GET scripts (one for whitepapers and one for rating), a POST script for creating new ratings, and a DELETE for clearing out ratings. At this point SomeCo has everything they need for building a front-end that talks to the Alfresco repository via REST. One piece of functionality I didn't show, but I've included in the source, is the ability for an optional “user” argument to be passed in to the two GET scripts. When present, the script will return the last rating for the specified user. I'll leave it to you to follow the source to figure out how that works.</p>
<h2 id="dealing-with-the-cross-domain-scripting-limitation"><a href="#dealing-with-the-cross-domain-scripting-limitation">Dealing with the cross-domain scripting limitation</a></h2>
<p>You may have noticed that in all of my URL examples, I'm using localhost. In fact, the static HTML pages (whitepaper index and whitepaper detail) that make AJAX calls are also on localhost. I did this to simplify the example but in real life, it is highly likely that the code making an AJAX call to your web script will reside on a different host than the one where Alfresco lives. This creates a problem called the “cross-domain scripting limitation”. The issue is that for security reasons browsers don't let you open an XMLHttpRequest to a different host than the one serving the page. There are a few ways you can handle this depending on your situation.</p>
<ul>
<li><strong>Use script tags</strong>. One way to work around the problem is to use a script tag in which the src attribute points to a location on a different host. The browser thinks it is loading a JavaScript file but what it is really doing is calling your web script which returns JSON. The script tags can be output dynamically through document.write.</li>
<li><strong>Use a proxy</strong>. Servers aren't subject to the browser's security constraints. You can easily write your own Java servlet that acts as a reverse proxy. AJAX calls go against the proxy and pass in the “real” URL as an argument. The servlet then invokes the URL and returns the results.</li>
<li><strong>Use a callback mechanism</strong>. Alfresco claims to have a callback mechanism built in to the web script run-time. The way it is supposed to work is that you pass in a function name as an argument to the web script like “&amp;alf_callback=someFunction”. The function is supposed to get called when the page is loaded. I couldn't get it working and ended up filing a Jira ticket.</li>
<li><strong>Deploy everything to the same server</strong>. This is the least likely scenario to work in a production implementation but it's the one I chose for this article so we wouldn't have to spend a lot of time on the issue. The scripts and images the ratings widget depends on reside in someco/javascript and someco/images, respectively, under the Alfresco web root. The whitepaper index and whitepaper details pages I used for the screenshots at the beginning of the article are enhanced copies of the files used for the Optaros web site deployed to the ROOT web application folder.</li>
</ul>
<h2 id="deploying-and-testing"><a href="#deploying-and-testing">Deploying and Testing</a></h2>
<p>To run the sample as-is, all you have to do is:</p>
<ol style="list-style-type: decimal">
<li>Import the web-script-article-project.zip file into Eclipse.</li>
<li>Change build.properties to match your environment.</li>
<li>Run the default Ant task.</li>
</ol>
<p>The default Ant task will compile all necessary code, JAR it up, zip up the JAR and the extensions into the appropriate folder structure, and then unzip on top of the Alfresco web root which deploys the custom model, Spring config files, web client customizations, scripts, web scripts, and the images and JavaScript for the rating.get.html page to the appropriate directories.</p>
<p>After an error-free start up, create Someco/Whitepapers in your Company Home and upload a couple of test whitepapers. Upload and execute the addTestRating.js script in the context of each test whitepaper to create test rating objects.</p>
<p>You should then be able to run any of the web scripts identified in this article without any problems.</p>
<p>In case you are curious, my environment is:</p>
<ul>
<li>Ubuntu Dapper Drake</li>
<li>MySQL 4.1 (with version 5.0.3 of the JDBC driver)</li>
<li>Java 1.5.0_12</li>
<li>Tomcat 5.5.x</li>
<li>Alfresco 2.1.0 Enterprise, WAR-only distribution</li>
</ul>
<p>Obviously, other operating systems, databases, and application servers will work as well. Web Scripts, however, only work starting with Alfresco 2.1.</p>
<h1 id="conclusion"><a href="#conclusion">Conclusion</a></h1>
<p>This article has given you an introduction to the Alfresco Web Script Framework. We began with a very simple Hello World script and then gradually moved to more complex examples which culminated in a REST API for retrieving whitepapers, getting the average rating for a specific whitepaper, posting new ratings for a given whitepaper, and deleting all ratings for a specific whitepaper. We used both JavaScript and Java to implement controller logic. We used FreeMarker to output HTML as well as JSON. We saw some options for working around the cross-domain scripting limitation.</p>
<p>There are still topics left to explore. One example is using Web Scripts to integrate a portal like Liferay or JBoss Portal with Alfresco. Another is Microsoft Office-Alfresco integration which is based on Web Scripts. And what about using Web Scripts to customize the Web Client user interface? Hopefully, you've been inspired enough to take a look at those topics on your own. Maybe you'll even blog about your experience. If so, or if you have any other feedback, please let me know. I'd love to hear from you.</p>
<h1 id="where-to-find-more-information"><a href="#where-to-find-more-information">Where to find more information</a></h1>
<ul>
<li>The complete source code that accompanies this article is available <a href="http://ecmarchitect.com/images/articles/alfresco-webscripts/web-script-article-project.zip">here</a> from <a href="http://ecmarchitect.com/">ecmarchitect.com</a>.</li>
<li>You may also enjoy previous articles in the Alfresco Developer series at ecmarchitect.com:
<ul>
<li><a href="http://ecmarchitect.com/archives/2007/09/26/770">“Implementing custom behaviors”</a>, September, 2007.</li>
<li>“<a href="http://ecmarchitect.com/images/articles/alfresco-content/content-article.pdf">Working with Custom Content Types</a>”, June, 2007.</li>
<li><a href="http://ecmarchitect.com/archives/2007/01/10/732">“Developing custom actions”</a>, January, 2007.</li>
</ul></li>
<li><a href="http://wiki.alfresco.com/wiki/Web_Scripts">Alfresco wiki pages related to this topic:</a>
<ul>
<li><a href="http://wiki.alfresco.com/wiki/Web_Scripts">Alfresco Web Scripts</a> wiki page</li>
<li><a href="http://wiki.alfresco.com/wiki/Web_Script_Runtimes">Alfresco Web Script Runtimes</a> wiki page</li>
<li><a href="http://wiki.alfresco.com/wiki/JavaScript_API">Alfresco JavaScript API</a> wiki page</li>
<li><a href="http://wiki.alfresco.com/wiki/Template_Guide">Alfresco Template Guide</a> (FreeMarker info) wiki page</li>
<li>For deployment help, see the <a href="http://wiki.alfresco.com/wiki/Web_Client_Configuration_Guide">Client Configuration Guide</a> and <a href="http://wiki.alfresco.com/wiki/Packaging_And_Deploying_Extensions">Packaging and Deploying Extensions</a> in the Alfresco wiki.</li>
<li>For general development help, see the <a href="http://wiki.alfresco.com/wiki/Developer_Guide">Developer Guide</a>.</li>
<li>For help customizing the data dictionary, see the <a href="http://wiki.alfresco.com/wiki/Data_Dictionary_Guide">Data Dictionary</a> wiki page.</li>
</ul></li>
<li>Luis Sala's presentation on Web Scripts at the West Coast Alfresco+Liferay Meetup along with a podcast of the audio portion of the presentation is available at <a href="http://blogs.alfresco.com/luissala/2007/09/12/alfresco-and-liferay-meetup-podcast-1-web-scripts/">Luis' Fresh Talk blog</a>.</li>
<li>Learn more about JSON at <a href="http://www.json.org/">json.org</a> and FreeMarker at <a href="http://freemarker.sourceforge.net/">freemarker.sourceforge.net</a>.</li>
<li>The <a href="https://ajax.dev.java.net/download.html">jMaki Project</a> is a framework for building Ajax-enabled, Java web applications. Included as part of it is a proxy you can use to work around the cross-domain scripting limitation if you don't want to write your own.</li>
<li>The JSR-168 Portlet Specification is available on the <a href="http://jcp.org/aboutJava/communityprocess/final/jsr168/index.html">Java Community Process site</a>.</li>
</ul>
<h1 id="footnotes"><a href="#footnotes">Footnotes</a></h1>
<p><a href="#sdfootnote1anc">1</a>It isn't required that you use the “Web Scripts Extensions” folder in the repository. I did it because it seemed consistent with how web client customizations are deployed (using the alfresco/extension folder). Web scripts placed in the “Web Scripts Extensions” folder that have the same file names as those in the “Web Scripts” folder will override the scripts stored in “Web Scripts”. For this reason, if you want others to be able to override your scripts, use the “Web Scripts” folder rather than “Web Scripts Extensions”. See the Alfresco wiki for more on web script folder search order.</p>
<p><a href="#sdfootnote2anc">2</a>I used the code at <a href="http://www.progressive-coding.com/tutorial.php?id=6">http://www.progressive-coding.com/tutorial.php?id=6</a> as the starting point for the rating widget. Most of it is unchanged with the exception of changing the ratings from being 0-indexed to being 1-indexed and following the author's instructions to hook the widget into the page using Prototype which I already happened to have lying around.</p>
					</div><!-- .entry-content -->
				</div><!-- #post-## -->
			</div><!-- #content -->
		</div><!-- #container -->
	</div><!-- #main -->
	<div id="footer" role="contentinfo">
		<div id="colophon">
			<div id="site-info">
				<p><a href="http://ecmarchitect.com/"
		title="ECM Architect" rel="home">ECM
		Architect</a></p>
			  
<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.			  
			</div><!-- #site-info -->
		</div><!-- #colophon -->
	</div><!-- #footer -->
<div class="github-fork-ribbon-wrapper right-bottom">
        <div class="github-fork-ribbon">
            <a href="https://github.com/jpotts/alfresco-developer-series">Fork me on GitHub</a>
        </div>
    </div>
</div><!-- header -->
</body>
</html>
